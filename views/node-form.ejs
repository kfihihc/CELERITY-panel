<div class="page-header">
    <a href="/panel/nodes" class="btn btn-back">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<div class="card">
    <div class="card-header">
        <h2><%= node ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–¥—ã' : '–ù–æ–≤–∞—è –Ω–æ–¥–∞' %></h2>
    </div>
    <div class="card-body">
        <form method="POST" action="/panel/nodes<%= node ? '/' + node._id : '' %>" class="form">
            <div class="form-row">
                <div class="form-group">
                    <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" id="name" name="name" value="<%= node?.name || '' %>" 
                           placeholder="–ì–µ—Ä–º–∞–Ω–∏—è, –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã..." required>
                    <small>–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø–æ–¥–ø–∏—Å–∫–µ –∫–ª–∏–µ–Ω—Ç–∞</small>
                </div>
                
                <div class="form-group">
                    <label for="ip">IP –∞–¥—Ä–µ—Å *</label>
                    <input type="text" id="ip" name="ip" value="<%= node?.ip || '' %>" 
                           placeholder="123.45.67.89" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="flag">–§–ª–∞–≥ (—ç–º–æ–¥–∑–∏)</label>
                    <input type="text" id="flag" name="flag" value="<%= node?.flag || '' %>" 
                           placeholder="üá©üá™">
                    <small>–≠–º–æ–¥–∑–∏ —Ñ–ª–∞–≥–∞ —Å—Ç—Ä–∞–Ω—ã</small>
                </div>
            </div>
            
                <div class="form-group">
                    <label for="domain">–î–æ–º–µ–Ω (–¥–ª—è SNI)</label>
                    <input type="text" id="domain" name="domain" value="<%= node?.domain || '' %>" 
                           placeholder="de.example.com">
                    <small>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è TLS –∏ –≤ –ø–æ–¥–ø–∏—Å–∫–µ</small>
                </div>
                
                <div class="form-group">
                <label>–ì—Ä—É–ø–ø—ã —Å–µ—Ä–≤–µ—Ä–æ–≤</label>
                <div class="groups-select">
                    <% if (groups && groups.length > 0) { %>
                        <% groups.forEach(group => { 
                            const isSelected = node?.groups?.some(g => g._id?.toString() === group._id.toString() || g.toString() === group._id.toString());
                        %>
                            <label class="checkbox-tag" style="border-color: <%= group.color %>">
                                <input type="checkbox" name="groups" value="<%= group._id %>" <%= isSelected ? 'checked' : '' %>>
                                <span class="tag-dot" style="background: <%= group.color %>"></span>
                                <span><%= group.name %></span>
                            </label>
                        <% }); %>
                    <% } else { %>
                        <p class="hint">–ù–µ—Ç –≥—Ä—É–ø–ø. <a href="/panel/groups">–°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É</a></p>
                    <% } %>
                </div>
                <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —ç—Ç–∏—Ö –≥—Ä—É–ø–ø –ø–æ–ª—É—á–∞—Ç –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –Ω–æ–¥–µ. –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º.</small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="port">–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ä—Ç</label>
                    <input type="number" id="port" name="port" value="<%= node?.port || 443 %>" 
                           placeholder="443">
                </div>
                
                <div class="form-group">
                    <label for="portRange">Port Hopping –¥–∏–∞–ø–∞–∑–æ–Ω</label>
                    <input type="text" id="portRange" name="portRange" value="<%= node?.portRange || '20000-50000' %>" 
                           placeholder="20000-50000">
                    <small>–ö–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–∏ –ø–æ—Ä—Ç—ã</small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="maxOnlineUsers">–õ–∏–º–∏—Ç –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
                    <input type="number" id="maxOnlineUsers" name="maxOnlineUsers" 
                           value="<%= node?.maxOnlineUsers || 0 %>" placeholder="0" min="0">
                    <small>0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –Ω–æ–¥–∞ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ).</small>
                </div>
                
                <div class="form-group">
                    <label for="rankingCoefficient">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (ranking)</label>
                    <input type="number" id="rankingCoefficient" name="rankingCoefficient" 
                           value="<%= node?.rankingCoefficient || 1 %>" placeholder="1" min="0" step="0.1">
                    <small>–ú–µ–Ω—å—à–µ = –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3>API —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="statsPort">–ü–æ—Ä—Ç API</label>
                        <input type="number" id="statsPort" name="statsPort" value="<%= node?.statsPort || 9999 %>">
                    </div>
                    <div class="form-group">
                        <label for="statsSecret">–°–µ–∫—Ä–µ—Ç API</label>
                        <input type="text" id="statsSecret" name="statsSecret" value="<%= node?.statsSecret || '' %>" 
                               placeholder="secret123">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>SSH –¥–æ—Å—Ç—É–ø (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
                <small class="section-hint">–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–º –Ω–æ–¥—ã</small>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sshPort">–ü–æ—Ä—Ç SSH</label>
                        <input type="number" id="sshPort" name="ssh.port" value="<%= node?.ssh?.port || 22 %>">
                    </div>
                    <div class="form-group">
                        <label for="sshUsername">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                        <input type="text" id="sshUsername" name="ssh.username" value="<%= node?.ssh?.username || 'root' %>">
                    </div>
                </div>
                <div class="form-group">
                    <label for="sshPassword">–ü–∞—Ä–æ–ª—å SSH <%= node?.ssh?.password ? '(—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)' : '' %></label>
                    <input type="password" id="sshPassword" name="ssh.password" 
                           placeholder="<%= node?.ssh?.password ? '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å' : '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å' %>">
                    <small class="hint">–ü–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Hysteria</h3>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="useCustomConfig" id="useCustomConfig" 
                               <%= node?.useCustomConfig ? 'checked' : '' %>
                               onchange="toggleCustomConfig()">
                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
                    </label>
                    <small>–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–Ω—Ñ–∏–≥ –Ω–∏–∂–µ –≤–º–µ—Å—Ç–æ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</small>
                </div>
                
                <div id="customConfigSection" style="<%= node?.useCustomConfig ? '' : 'display:none' %>">
                    <div class="form-group">
                        <label for="customConfig">–ö–æ–Ω—Ñ–∏–≥ config.yaml</label>
                        <textarea id="customConfig" name="customConfig" rows="20" 
                                  class="code-textarea" placeholder="listen: :443&#10;&#10;acme:&#10;  domains:&#10;    - example.com..."><%= node?.customConfig || '' %></textarea>
                        <small>YAML —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑–æ–≤—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º.</small>
                    </div>
                    <button type="button" class="btn btn-sm" onclick="generateConfig()">üìù –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥</button>
                    <button type="button" class="btn btn-sm" onclick="loadCurrentConfig()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å –Ω–æ–¥—ã</button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="active" <%= node?.active !== false ? 'checked' : '' %>>
                    –ù–æ–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞
                </label>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <%= node ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å –Ω–æ–¥—É' %>
                </button>
                <a href="/panel/nodes" class="btn">–û—Ç–º–µ–Ω–∞</a>
            </div>
        </form>
    </div>
</div>

<% if (node) { %>
<div class="card mt-3">
    <div class="card-header">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
    </div>
    <div class="card-body">
        <div class="actions-grid">
            <button class="action-btn" onclick="setupNode()" id="btnSetup">
                <span class="action-icon">‚öôÔ∏è</span>
                <span>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
            </button>
            <button class="action-btn" onclick="openTerminal()">
                <span class="action-icon">üñ•Ô∏è</span>
                <span>SSH –¢–µ—Ä–º–∏–Ω–∞–ª</span>
            </button>
            <button class="action-btn" onclick="getNodeLogs()">
                <span class="action-icon">üìã</span>
                <span>–õ–æ–≥–∏ Hysteria</span>
            </button>
            <button class="action-btn" onclick="checkStatus()">
                <span class="action-icon">üîç</span>
                <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</span>
            </button>
            <button class="action-btn" onclick="resetStatus()">
                <span class="action-icon">üîÑ</span>
                <span>–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å</span>
            </button>
        </div>
        <div id="setupResult" class="mt-2"></div>
        <div id="logsContainer" class="mt-2" style="display:none;">
            <div class="logs-header">
                <strong>üìã –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong>
                <button class="btn btn-sm" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <pre class="logs-output" id="logsOutput"></pre>
        </div>
    </div>
</div>

<style>
.logs-output {
    background: #1a1a2e;
    color: #0f0;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
    max-height: 500px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
    margin-top: 10px;
}
.logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.logs-output .error { color: #ff6b6b; }
.logs-output .success { color: #51cf66; }
.logs-output .warning { color: #ffd43b; }
</style>

<script>
function showLogs(logs) {
    const container = document.getElementById('logsContainer');
    const output = document.getElementById('logsOutput');
    container.style.display = 'block';
    
    let html = '';
    if (Array.isArray(logs)) {
        html = logs.map(line => {
            if (line.includes('‚úì') || line.includes('success')) return '<span class="success">' + escapeHtml(line) + '</span>';
            if (line.includes('‚ùå') || line.includes('Error') || line.includes('[STDERR]')) return '<span class="error">' + escapeHtml(line) + '</span>';
            if (line.includes('‚ö†')) return '<span class="warning">' + escapeHtml(line) + '</span>';
            return escapeHtml(line);
        }).join('\n');
    } else {
        html = escapeHtml(logs);
    }
    output.innerHTML = html;
    output.scrollTop = output.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearLogs() {
    document.getElementById('logsContainer').style.display = 'none';
    document.getElementById('logsOutput').innerHTML = '';
}

async function setupNode() {
    if (!confirm('–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ SSH?\n\n–≠—Ç–æ:\n‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç Hysteria (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)\n‚Ä¢ –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç\n‚Ä¢ –ó–∞–≥—Ä—É–∑–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é\n‚Ä¢ –ù–∞—Å—Ç—Ä–æ–∏—Ç port hopping\n‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å–µ—Ä–≤–∏—Å')) return;
    
    const btn = document.getElementById('btnSetup');
    btn.disabled = true;
    btn.innerHTML = '<span class="action-icon">‚è≥</span><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞...</span>';
    
    document.getElementById('setupResult').innerHTML = '<div class="alert">‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã.</div>';
    
    try {
        const res = await fetch('/panel/nodes/<%= node._id %>/setup', {
            method: 'POST',
        });
        const data = await res.json();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏
        if (data.logs) {
            showLogs(data.logs);
        }
        
        if (data.success) {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-success">‚úÖ ' + data.message + '</div>';
        } else {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + (data.error || '–û—à–∏–±–∫–∞') + '</div>';
        }
    } catch (err) {
        document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + err.message + '</div>';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="action-icon">‚öôÔ∏è</span><span>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>';
    }
}

async function getNodeLogs() {
    document.getElementById('setupResult').innerHTML = '<div class="alert">üìã –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>';
    
    try {
        const res = await fetch('/panel/nodes/<%= node._id %>/logs');
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('setupResult').innerHTML = '';
            showLogs(data.logs);
        } else {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + data.error + '</div>';
        }
    } catch (err) {
        document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + err.message + '</div>';
    }
}

async function checkStatus() {
    document.getElementById('setupResult').innerHTML = '<div class="alert">üîç –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>';
    
    try {
        const res = await fetch('/api/nodes/<%= node._id %>/status', {
            headers: { 'X-API-Key': window.API_KEY }
        });
        const data = await res.json();
        
        const statusColors = { online: 'alert-success', offline: 'alert-warning', error: 'alert-error' };
        const statusIcons = { online: '‚úÖ', offline: '‚ö†Ô∏è', error: '‚ùå' };
        const color = statusColors[data.status] || '';
        const icon = statusIcons[data.status] || '‚ùì';
        
        document.getElementById('setupResult').innerHTML = '<div class="alert ' + color + '">' + icon + ' –°—Ç–∞—Ç—É—Å: ' + data.status + '</div>';
    } catch (err) {
        document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞: ' + err.message + '</div>';
    }
}

function openTerminal() {
    window.open('/panel/nodes/<%= node._id %>/terminal', '_blank', 'width=1000,height=600');
}

async function resetStatus() {
    document.getElementById('setupResult').innerHTML = '<div class="alert">üîÑ –°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞...</div>';
    
    try {
        const res = await fetch('/api/nodes/<%= node._id %>/reset-status', {
            method: 'POST',
            headers: { 'X-API-Key': window.API_KEY }
        });
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-success">‚úÖ –°—Ç–∞—Ç—É—Å —Å–±—Ä–æ—à–µ–Ω –Ω–∞ online</div>';
        } else {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + (data.error || '–û—à–∏–±–∫–∞') + '</div>';
        }
    } catch (err) {
        document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞: ' + err.message + '</div>';
    }
}
</script>

<div class="card mt-3">
    <div class="card-header">
        <h2>–ö–æ–Ω—Ñ–∏–≥ –¥–ª—è –Ω–æ–¥—ã</h2>
    </div>
    <div class="card-body">
        <p class="hint">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–Ω—Ñ–∏–≥ –≤ <code>/etc/hysteria/config.yaml</code> –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:</p>
        <pre class="code-block"><code>listen: :<%= node.port %>

tls:
<% if (node.domain) { %>
  acme:
    domains:
      - <%= node.domain %>
    email: admin@<%= node.domain %>
<% } else { %>
  cert: /etc/hysteria/cert.pem
  key: /etc/hysteria/key.pem
<% } %>
  sniGuard: strict

auth:
  type: http
  http:
    url: <%= baseUrl %>/api/auth
    insecure: false

masquerade:
  type: string
  string:
    content: "Hello World"
    statusCode: 200

acl:
  inline:
    - reject(geoip:cn)</code></pre>
        <button class="btn btn-sm" onclick="copyConfig()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
</div>
<% } %>

<style>
.code-textarea {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    background: #1a1a2e;
    color: #e0e0e0;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 15px;
    width: 100%;
    resize: vertical;
    line-height: 1.5;
}
.code-textarea:focus {
    outline: none;
    border-color: #1a659e;
}
</style>

<script>
function copyConfig() {
    const code = document.querySelector('.code-block code').textContent;
    navigator.clipboard.writeText(code);
    alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
}

function toggleCustomConfig() {
    const checked = document.getElementById('useCustomConfig').checked;
    document.getElementById('customConfigSection').style.display = checked ? 'block' : 'none';
}

function generateConfig() {
    const name = document.getElementById('name').value || 'Node';
    const domain = document.getElementById('domain').value;
    const port = document.getElementById('port').value || 443;
    const statsPort = document.getElementById('statsPort').value || 9999;
    const statsSecret = document.getElementById('statsSecret').value || 'secret';
    const portRange = document.getElementById('portRange').value || '20000-50000';
    
    let tlsSection;
    if (domain) {
        tlsSection = `acme:
  domains:
    - ${domain}
  email: admin@${domain}
  dir: /etc/hysteria/acme
  listenHost: 0.0.0.0`;
    } else {
        tlsSection = `tls:
  cert: /etc/hysteria/cert.pem
  key: /etc/hysteria/key.pem`;
    }
    
    const config = `# Hysteria 2 Config - ${name}
# Generated: ${new Date().toISOString()}

listen: :${port}

${tlsSection}

sniff:
  enable: true
  timeout: 2s
  rewriteDomain: false
  tcpPorts: 80,443,8000-9000
  udpPorts: 443,80,53

quic:
  initStreamReceiveWindow: 8388608
  maxStreamReceiveWindow: 8388608
  initConnReceiveWindow: 20971520
  maxConnReceiveWindow: 20971520
  maxIdleTimeout: 60s
  maxIncomingStreams: 256

auth:
  type: http
  http:
    url: <%= baseUrl %>/api/auth
    insecure: false

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
# bandwidth:
#   up: 100 mbps
#   down: 100 mbps
# ignoreClientBandwidth: true

masquerade:
  type: string
  string:
    content: "Service Unavailable"
    headers:
      Content-Type: text/plain
    statusCode: 503

acl:
  inline:
    - reject(geoip:cn)
    - reject(geoip:private)

trafficStats:
  listen: :${statsPort}
  secret: ${statsSecret}
`;
    
    document.getElementById('customConfig').value = config;
}

async function loadCurrentConfig() {
    <% if (node) { %>
    if (!confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ñ–∏–≥ —Å –Ω–æ–¥—ã —á–µ—Ä–µ–∑ SSH?')) return;
    
    try {
        const res = await fetch('/panel/nodes/<%= node._id %>/get-config');
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('customConfig').value = data.config;
            alert('–ö–æ–Ω—Ñ–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω!');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
    <% } else { %>
    alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–æ–¥—É');
    <% } %>
}
</script>

