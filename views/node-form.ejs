<div class="page-header">
    <a href="/panel/nodes" class="btn btn-back"><%= t('common.backToList') %></a>
</div>

<div class="card">
    <div class="card-header">
        <h2><%= node ? t('nodes.editNode') : t('nodes.newNode') %></h2>
    </div>
    <div class="card-body">
        <form method="POST" action="/panel/nodes<%= node ? '/' + node._id : '' %>" class="form">
            <div class="form-row">
                <div class="form-group">
                    <label for="name"><%= t('nodes.nodeName') %></label>
                    <input type="text" id="name" name="name" value="<%= node?.name || '' %>" 
                           placeholder="<%= t('nodes.nodeNamePlaceholder') %>" required>
                    <small><%= t('nodes.nodeNameHint') %></small>
                </div>
                
                <div class="form-group">
                    <label for="ip"><%= t('nodes.ipAddress') %></label>
                    <input type="text" id="ip" name="ip" value="<%= node?.ip || '' %>" 
                           placeholder="123.45.67.89" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="flag"><%= t('nodes.flag') %></label>
                    <input type="text" id="flag" name="flag" value="<%= node?.flag || '' %>" 
                           placeholder="<%= t('nodes.flagPlaceholder') %>">
                    <small><%= t('nodes.flagHint') %></small>
                </div>
            </div>
            
                <div class="form-group">
                    <label for="domain"><%= t('nodes.domain') %></label>
                    <input type="text" id="domain" name="domain" value="<%= node?.domain || '' %>" 
                           placeholder="de.example.com">
                    <small><%= t('nodes.domainHint') %></small>
                </div>
                
                <div class="form-group">
                    <label for="sni"><%= t('nodes.sni') || 'SNI (Server Name Indication)' %></label>
                    <input type="text" id="sni" name="sni" value="<%= node?.sni || '' %>" 
                           placeholder="google.com">
                    <small><%= t('nodes.sniHint') || 'Custom SNI for client connections (for domain fronting). If empty, domain or IP will be used.' %></small>
                </div>
                
                <div class="form-group">
                <label><%= t('nodes.groups') %></label>
                <div class="groups-select">
                    <% if (groups && groups.length > 0) { %>
                        <% groups.forEach(group => { 
                            const isSelected = node?.groups?.some(g => g._id?.toString() === group._id.toString() || g.toString() === group._id.toString());
                        %>
                            <label class="checkbox-tag" style="border-color: <%= group.color %>">
                                <input type="checkbox" name="groups" value="<%= group._id %>" <%= isSelected ? 'checked' : '' %>>
                                <span class="tag-dot" style="background: <%= group.color %>"></span>
                                <span><%= group.name %></span>
                            </label>
                        <% }); %>
                    <% } else { %>
                        <p class="hint"><%= t('nodes.noGroups') %> <a href="/panel/groups"><%= t('nodes.createGroup') %></a></p>
                    <% } %>
                </div>
                <small><%= t('nodes.groupsHint') %></small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="port"><%= t('nodes.port') %></label>
                    <input type="number" id="port" name="port" value="<%= node?.port || 443 %>" 
                           placeholder="443">
                </div>
                
                <div class="form-group">
                    <label for="portRange"><%= t('nodes.portRange') %></label>
                    <input type="text" id="portRange" name="portRange" value="<%= node?.portRange || '20000-50000' %>" 
                           placeholder="20000-50000">
                    <small><%= t('nodes.portRangeHint') %></small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="maxOnlineUsers"><%= t('nodes.maxOnlineUsers') %></label>
                    <input type="number" id="maxOnlineUsers" name="maxOnlineUsers" 
                           value="<%= node?.maxOnlineUsers || 0 %>" placeholder="0" min="0">
                    <small><%= t('nodes.maxOnlineHint') %></small>
                </div>
                
                <div class="form-group">
                    <label for="rankingCoefficient"><%= t('nodes.rankingCoefficient') %></label>
                    <input type="number" id="rankingCoefficient" name="rankingCoefficient" 
                           value="<%= node?.rankingCoefficient || 1 %>" placeholder="1" min="0" step="0.1">
                    <small><%= t('nodes.rankingHint') %></small>
                </div>
            </div>
            
            <div class="form-section">
                <h3><%= t('nodes.statsPort') %> API</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="statsPort"><%= t('nodes.statsPort') %></label>
                        <input type="number" id="statsPort" name="statsPort" value="<%= node?.statsPort || 9999 %>">
                    </div>
                    <div class="form-group">
                        <label for="statsSecret"><%= t('nodes.statsSecret') %></label>
                        <div class="input-with-button">
                            <input type="text" id="statsSecret" name="statsSecret" value="<%= node?.statsSecret || '' %>" 
                                   placeholder="secret123">
                            <button type="button" class="btn btn-sm" onclick="generateSecret()" title="Generate random secret">üé≤</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3><%= t('nodes.sshSettings') %></h3>
                <small class="section-hint"><%= t('nodes.sshSettingsHint') %></small>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sshPort"><%= t('nodes.sshPort') %></label>
                        <input type="number" id="sshPort" name="ssh.port" value="<%= node?.ssh?.port || 22 %>">
                    </div>
                    <div class="form-group">
                        <label for="sshUsername"><%= t('nodes.sshUsername') %></label>
                        <input type="text" id="sshUsername" name="ssh.username" value="<%= node?.ssh?.username || 'root' %>">
                    </div>
                </div>
                <div class="form-group">
                    <label for="sshPassword"><%= t('nodes.sshPassword') %> <%= node?.ssh?.password ? t('nodes.sshPasswordSet') : '' %></label>
                    <input type="password" id="sshPassword" name="ssh.password" 
                           placeholder="<%= node?.ssh?.password ? t('nodes.sshPasswordKeep') : t('nodes.sshPasswordPlaceholder') %>">
                    <small class="hint"><%= t('nodes.sshPasswordEncrypted') %></small>
                </div>
            </div>
            
            <div class="form-section">
                <h3><%= t('nodes.hysteriaConfig') %></h3>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="useCustomConfig" id="useCustomConfig" 
                               <%= node?.useCustomConfig ? 'checked' : '' %>
                               onchange="toggleCustomConfig()">
                        <%= t('nodes.useCustomConfig') %>
                    </label>
                    <small><%= t('nodes.customConfigHint') %></small>
                </div>
                
                <div id="customConfigSection" style="<%= node?.useCustomConfig ? '' : 'display:none' %>">
                    <div class="form-group">
                        <label for="customConfig"><%= t('nodes.customConfigLabel') %></label>
                        <textarea id="customConfig" name="customConfig" rows="20" 
                                  class="code-textarea" placeholder="listen: :443&#10;&#10;acme:&#10;  domains:&#10;    - example.com..."><%= node?.customConfig || '' %></textarea>
                        <small><%= t('nodes.customConfigFormat') %></small>
                    </div>
                    <button type="button" class="btn btn-sm" onclick="generateConfig()"><%= t('nodes.generateConfig') %></button>
                    <button type="button" class="btn btn-sm" onclick="loadCurrentConfig()"><%= t('nodes.loadCurrentConfig') %></button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="active" <%= node?.active !== false ? 'checked' : '' %>>
                    <%= t('nodes.nodeActive') %>
                </label>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <%= node ? t('nodes.saveNode') : t('nodes.createNode') %>
                </button>
                <a href="/panel/nodes" class="btn"><%= t('common.cancel') %></a>
            </div>
        </form>
    </div>
</div>

<% if (node) { %>
<div class="card mt-3">
    <div class="card-header">
        <h2><%= t('nodes.management') %></h2>
    </div>
    <div class="card-body">
        <% if (!node.ssh?.password && !node.ssh?.privateKey) { %>
        <div class="ssh-warning" id="sshWarning">
            <span class="ssh-warning-icon">‚ö†Ô∏è</span>
            <span><%= t('nodes.sshNotConfigured') || 'SSH not configured. Auto-setup and terminal require SSH credentials.' %></span>
        </div>
        <% } %>
        <div class="actions-grid">
            <button class="action-btn" onclick="setupNode()" id="btnSetup" <%= !node.ssh?.password && !node.ssh?.privateKey ? 'disabled title="Configure SSH first"' : '' %>>
                <span class="action-icon">‚öôÔ∏è</span>
                <span><%= t('nodes.autoSetup') %></span>
            </button>
            <button class="action-btn" onclick="openTerminal()">
                <span class="action-icon">üñ•Ô∏è</span>
                <span><%= t('nodes.terminal') %></span>
            </button>
            <button class="action-btn" onclick="getNodeLogs()">
                <span class="action-icon">üìã</span>
                <span><%= t('nodes.viewLogs') %></span>
            </button>
            <button class="action-btn" onclick="checkStatus()">
                <span class="action-icon">üîç</span>
                <span><%= t('nodes.checkStatus') %></span>
            </button>
            <button class="action-btn" onclick="resetStatus()">
                <span class="action-icon">üîÑ</span>
                <span><%= t('nodes.resetStatus') %></span>
            </button>
        </div>
        <div id="setupResult" class="mt-2"></div>
        <div id="logsContainer" class="mt-2" style="display:none;">
            <div class="logs-header">
                <strong><%= t('nodes.executionLogs') %></strong>
                <button class="btn btn-sm" onclick="clearLogs()"><%= t('common.clear') %></button>
            </div>
            <pre class="logs-output" id="logsOutput"></pre>
        </div>
    </div>
</div>

<style>
.logs-output {
    background: #1a1a2e;
    color: #0f0;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
    max-height: 500px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
    margin-top: 10px;
}
.logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.logs-output .error { color: #ff6b6b; }
.logs-output .success { color: #51cf66; }
.logs-output .warning { color: #ffd43b; }
</style>

<script>
const i18n = {
    autoSetupConfirm: <%- JSON.stringify(t("nodes.autoSetupConfirm")) %>,
    setupRunning: <%- JSON.stringify(t("nodes.setupRunning")) %>,
    loadingLogs: <%- JSON.stringify(t("nodes.loadingLogs")) %>,
    checking: <%- JSON.stringify(t("nodes.checking")) %>,
    resettingStatus: <%- JSON.stringify(t("nodes.resettingStatus")) %>,
    statusReset: <%- JSON.stringify(t("nodes.statusReset")) %>,
    autoSetup: <%- JSON.stringify(t("nodes.autoSetup")) %>,
    error: <%- JSON.stringify(t("common.error")) %>
};

function showLogs(logs) {
    const container = document.getElementById('logsContainer');
    const output = document.getElementById('logsOutput');
    container.style.display = 'block';
    
    let html = '';
    if (Array.isArray(logs)) {
        html = logs.map(line => {
            if (line.includes('‚úì') || line.includes('success')) return '<span class="success">' + escapeHtml(line) + '</span>';
            if (line.includes('‚ùå') || line.includes('Error') || line.includes('[STDERR]')) return '<span class="error">' + escapeHtml(line) + '</span>';
            if (line.includes('‚ö†')) return '<span class="warning">' + escapeHtml(line) + '</span>';
            return escapeHtml(line);
        }).join('\n');
    } else {
        html = escapeHtml(logs);
    }
    output.innerHTML = html;
    output.scrollTop = output.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearLogs() {
    document.getElementById('logsContainer').style.display = 'none';
    document.getElementById('logsOutput').innerHTML = '';
}

async function setupNode() {
    if (!confirm(i18n.autoSetupConfirm)) return;
    
    const btn = document.getElementById('btnSetup');
    btn.disabled = true;
    btn.innerHTML = '<span class="action-icon">‚è≥</span><span>...</span>';
    
    document.getElementById('setupResult').innerHTML = '<div class="alert">' + i18n.setupRunning + '</div>';
    
    try {
        const res = await fetch('/panel/nodes/<%= node._id %>/setup', {
            method: 'POST',
        });
        const data = await res.json();
        
        if (data.logs) {
            showLogs(data.logs);
        }
        
        if (data.success) {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-success">‚úÖ ' + data.message + '</div>';
        } else {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + (data.error || i18n.error) + '</div>';
        }
    } catch (err) {
        document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + err.message + '</div>';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="action-icon">‚öôÔ∏è</span><span>' + i18n.autoSetup + '</span>';
    }
}

async function getNodeLogs() {
    document.getElementById('setupResult').innerHTML = '<div class="alert">' + i18n.loadingLogs + '</div>';
    
    try {
        const res = await fetch('/panel/nodes/<%= node._id %>/logs');
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('setupResult').innerHTML = '';
            showLogs(data.logs);
        } else {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + data.error + '</div>';
        }
    } catch (err) {
        document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + err.message + '</div>';
    }
}

async function checkStatus() {
    document.getElementById('setupResult').innerHTML = '<div class="alert">' + i18n.checking + '</div>';
    
    try {
        const res = await fetch('/api/nodes/<%= node._id %>/status', {
            headers: { 'X-API-Key': window.API_KEY }
        });
        const data = await res.json();
        
        const statusColors = { online: 'alert-success', offline: 'alert-warning', error: 'alert-error' };
        const statusIcons = { online: '‚úÖ', offline: '‚ö†Ô∏è', error: '‚ùå' };
        const color = statusColors[data.status] || '';
        const icon = statusIcons[data.status] || '‚ùì';
        
        document.getElementById('setupResult').innerHTML = '<div class="alert ' + color + '">' + icon + ' Status: ' + data.status + '</div>';
    } catch (err) {
        document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">' + i18n.error + ': ' + err.message + '</div>';
    }
}

function openTerminal() {
    window.open('/panel/nodes/<%= node._id %>/terminal', '_blank', 'width=1000,height=600');
}

async function resetStatus() {
    document.getElementById('setupResult').innerHTML = '<div class="alert">' + i18n.resettingStatus + '</div>';
    
    try {
        const res = await fetch('/api/nodes/<%= node._id %>/reset-status', {
            method: 'POST',
            headers: { 'X-API-Key': window.API_KEY }
        });
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-success">' + i18n.statusReset + '</div>';
        } else {
            document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">‚ùå ' + (data.error || i18n.error) + '</div>';
        }
    } catch (err) {
        document.getElementById('setupResult').innerHTML = '<div class="alert alert-error">' + i18n.error + ': ' + err.message + '</div>';
    }
}
</script>

<div class="card mt-3">
    <div class="card-header">
        <h2><%= t('nodes.nodeConfig') %></h2>
    </div>
    <div class="card-body">
        <p class="hint"><%- t('nodes.configHint') %></p>
        <pre class="code-block"><code>listen: :<%= node.port %>

tls:
<% if (node.domain) { %>
  acme:
    domains:
      - <%= node.domain %>
    email: admin@<%= node.domain %>
<% } else { %>
  cert: /etc/hysteria/cert.pem
  key: /etc/hysteria/key.pem
<% } %>
  sniGuard: strict

auth:
  type: http
  http:
    url: <%= baseUrl %>/api/auth
    insecure: false

masquerade:
  type: string
  string:
    content: "Hello World"
    statusCode: 200

acl:
  inline:
    - reject(geoip:cn)</code></pre>
        <button class="btn btn-sm" onclick="copyConfig()"><%= t('common.copy') %></button>
    </div>
</div>
<% } %>

<style>
.code-textarea {
    font-family: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 15px;
    width: 100%;
    resize: vertical;
    line-height: 1.5;
}
.code-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px var(--accent-glow);
}
.input-with-button {
    display: flex;
    gap: 8px;
    align-items: center;
}
.input-with-button input {
    flex: 1;
}
.input-with-button .btn {
    white-space: nowrap;
    flex-shrink: 0;
}
.ssh-warning {
    background: var(--warning-bg);
    border: 1px solid var(--warning);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    margin-bottom: 16px;
    color: var(--warning);
    display: flex;
    align-items: center;
    gap: 10px;
}
.ssh-warning-icon {
    font-size: 20px;
}
</style>

<script>
const i18nConfig = {
    copied: <%- JSON.stringify(t("common.copied")) %>,
    loadConfigConfirm: <%- JSON.stringify(t("nodes.loadConfigConfirm")) %>,
    configLoaded: <%- JSON.stringify(t("nodes.configLoaded")) %>,
    saveFirst: <%- JSON.stringify(t("nodes.saveFirst")) %>,
    error: <%- JSON.stringify(t("common.error")) %>,
    baseUrl: <%- JSON.stringify(baseUrl) %>
};

function copyConfig() {
    const code = document.querySelector('.code-block code').textContent;
    navigator.clipboard.writeText(code);
    alert(i18nConfig.copied);
}

function generateSecret() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let secret = '';
    for (let i = 0; i < 32; i++) {
        secret += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('statsSecret').value = secret;
}

function toggleCustomConfig() {
    const checked = document.getElementById('useCustomConfig').checked;
    document.getElementById('customConfigSection').style.display = checked ? 'block' : 'none';
}

function generateConfig() {
    const name = document.getElementById('name').value || 'Node';
    const domain = document.getElementById('domain').value;
    const port = document.getElementById('port').value || 443;
    const statsPort = document.getElementById('statsPort').value || 9999;
    const statsSecret = document.getElementById('statsSecret').value || 'secret';
    const portRange = document.getElementById('portRange').value || '20000-50000';
    
    let tlsSection;
    if (domain) {
        tlsSection = `acme:
  domains:
    - ${domain}
  email: admin@${domain}
  dir: /etc/hysteria/acme
  listenHost: 0.0.0.0`;
    } else {
        tlsSection = `tls:
  cert: /etc/hysteria/cert.pem
  key: /etc/hysteria/key.pem`;
    }
    
    const config = `# Hysteria 2 Config - ${name}
# Generated: ${new Date().toISOString()}

listen: :${port}

${tlsSection}

sniff:
  enable: true
  timeout: 2s
  rewriteDomain: false
  tcpPorts: 80,443,8000-9000
  udpPorts: 443,80,53

quic:
  initStreamReceiveWindow: 8388608
  maxStreamReceiveWindow: 8388608
  initConnReceiveWindow: 20971520
  maxConnReceiveWindow: 20971520
  maxIdleTimeout: 60s
  maxIncomingStreams: 256

auth:
  type: http
  http:
    url: ${i18nConfig.baseUrl}/api/auth
    insecure: false

# bandwidth:
#   up: 100 mbps
#   down: 100 mbps
# ignoreClientBandwidth: true

masquerade:
  type: string
  string:
    content: "Service Unavailable"
    headers:
      Content-Type: text/plain
    statusCode: 503

acl:
  inline:
    - reject(geoip:cn)
    - reject(geoip:private)

trafficStats:
  listen: :${statsPort}
  secret: ${statsSecret}
`;
    
    document.getElementById('customConfig').value = config;
}

async function loadCurrentConfig() {
    <% if (node) { %>
    if (!confirm(i18nConfig.loadConfigConfirm)) return;
    
    try {
        const res = await fetch('/panel/nodes/<%= node._id %>/get-config');
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('customConfig').value = data.config;
            alert(i18nConfig.configLoaded);
        } else {
            alert(i18nConfig.error + ': ' + data.error);
        }
    } catch (err) {
        alert(i18nConfig.error + ': ' + err.message);
    }
    <% } else { %>
    alert(i18nConfig.saveFirst);
    <% } %>
}
</script>
