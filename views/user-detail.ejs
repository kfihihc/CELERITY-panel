<div class="page-header">
    <a href="/panel/users" class="btn btn-back">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<div class="row">
    <div class="col-8">
        <div class="card">
            <div class="card-header">
                <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <%= user.userId %></h2>
                <span class="badge badge-<%= user.enabled ? 'success' : 'secondary' %> badge-lg">
                    <%= user.enabled ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' %>
                </span>
            </div>
            <div class="card-body">
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>User ID</label>
                        <code class="value"><%= user.userId %></code>
                    </div>
                    <div class="detail-item">
                        <label>Username</label>
                        <span class="value"><%= user.username || '‚Äî' %></span>
                    </div>
                    <div class="detail-item">
                        <label>–ü–∞—Ä–æ–ª—å Hysteria</label>
                        <code class="value"><%= user.password %></code>
                    </div>
                </div>
                
                <h3 class="section-title">–ì—Ä—É–ø–ø—ã</h3>
                <div class="groups-list">
                    <% if (user.groups && user.groups.length > 0) { %>
                        <% user.groups.forEach(group => { %>
                            <span class="group-tag" style="background: <%= group.color %>20; border-color: <%= group.color %>; color: <%= group.color %>">
                                <%= group.name %>
                            </span>
                        <% }); %>
                    <% } else { %>
                        <span class="text-muted">–ù–µ—Ç –≥—Ä—É–ø–ø (–¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –Ω–æ–¥–∞–º –±–µ–∑ –≥—Ä—É–ø–ø)</span>
                    <% } %>
                </div>
                
                <h3 class="section-title">–õ–∏–º–∏—Ç—ã</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>–¢—Ä–∞—Ñ–∏–∫</label>
                        <% const used = ((user.traffic?.tx || 0) + (user.traffic?.rx || 0)) / (1024*1024*1024); %>
                        <% const limit = user.trafficLimit ? user.trafficLimit / (1024*1024*1024) : 0; %>
                        <span class="value"><%= used.toFixed(2) %> / <%= limit > 0 ? limit.toFixed(0) + ' GB' : '‚àû' %></span>
                    </div>
                    <div class="detail-item">
                        <label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                        <% 
                            let deviceLimit = user.maxDevices;
                            let deviceLimitStr = '‚àû';
                            if (deviceLimit === 0) {
                                // –ë–µ—Ä—ë–º –∏–∑ –≥—Ä—É–ø–ø
                                const groupLimits = (user.groups || []).filter(g => g.maxDevices > 0).map(g => g.maxDevices);
                                if (groupLimits.length > 0) {
                                    deviceLimit = Math.min(...groupLimits);
                                    deviceLimitStr = deviceLimit + ' (–≥—Ä—É–ø–ø–∞)';
                                }
                            } else if (deviceLimit > 0) {
                                deviceLimitStr = deviceLimit.toString();
                            }
                        %>
                        <span class="value"><%= deviceLimitStr %></span>
                    </div>
                    <div class="detail-item">
                        <label>TX / RX</label>
                        <span class="value">
                            ‚Üë <%= ((user.traffic?.tx || 0) / (1024*1024*1024)).toFixed(2) %> / 
                            ‚Üì <%= ((user.traffic?.rx || 0) / (1024*1024*1024)).toFixed(2) %> GB
                        </span>
                    </div>
                    <div class="detail-item">
                        <label>–ò—Å—Ç–µ–∫–∞–µ—Ç</label>
                        <span class="value"><%= user.expireAt ? new Date(user.expireAt).toLocaleDateString('ru') : '–ë–µ—Å—Å—Ä–æ—á–Ω–æ' %></span>
                    </div>
                </div>
                
                <h3 class="section-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–¥—ã (<%= user.nodes?.length || 0 %>)</h3>
                <div class="nodes-list">
                    <% if (user.nodes && user.nodes.length > 0) { %>
                        <% user.nodes.forEach(node => { %>
                        <div class="node-badge">
                            <span class="node-name"><%= node.name %></span>
                            <span class="node-ip"><%= node.ip %></span>
                        </div>
                        <% }); %>
                    <% } else { %>
                        <span class="text-muted">–ù–µ—Ç –Ω–æ–¥</span>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-4">
        <div class="card">
            <div class="card-header">
                <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
            </div>
            <div class="card-body">
                <div class="actions-list">
                    <% if (user.enabled) { %>
                    <button class="btn btn-warning btn-block" onclick="toggleUser(false)">
                        –û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </button>
                    <% } else { %>
                    <button class="btn btn-success btn-block" onclick="toggleUser(true)">
                        –í–∫–ª—é—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </button>
                    <% } %>
                    
                    <button class="btn btn-block" onclick="copySubscription()">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                    </button>
                    
                    <a href="<%= baseUrl %>/api/files/<%= user.subscriptionToken || user.userId %>" 
                       target="_blank" class="btn btn-block">
                        üîó –û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                    </a>
                    
                    <hr>
                    
                    <button class="btn btn-danger btn-block" onclick="deleteUser()">
                        –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2>–°—Å—ã–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏</h2>
            </div>
            <div class="card-body">
                <div id="qrcode" style="text-align:center;margin-bottom:12px;"></div>
                <p class="hint mb-1">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è + –±—Ä–∞—É–∑–µ—Ä):</p>
                <input type="text" readonly class="input-readonly" 
                       value="<%= baseUrl %>/api/files/<%= user.subscriptionToken || user.userId %>" id="subLink">
                <button class="btn btn-sm btn-block mt-1" onclick="copySubscription()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
const userId = '<%= user.userId %>';

async function toggleUser(enabled) {
    const res = await fetch(`/api/users/${userId}/${enabled ? 'enable' : 'disable'}`, {
        method: 'POST',
        headers: { 'X-API-Key': window.API_KEY }
    });
    if (res.ok) location.reload();
    else alert('–û—à–∏–±–∫–∞');
}

async function deleteUser() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ' + userId + '?')) return;
    
    const res = await fetch(`/api/users/${userId}`, {
        method: 'DELETE',
        headers: { 'X-API-Key': window.API_KEY }
    });
    if (res.ok) location.href = '/panel/users';
    else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
}

function copySubscription() {
    const link = document.getElementById('subLink').value;
    navigator.clipboard.writeText(link).then(() => {
        alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    }).catch(() => {
    document.getElementById('subLink').select();
    document.execCommand('copy');
    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    });
}

// QR-–∫–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–±–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
const subUrl = document.getElementById('subLink').value;
QRCode.toCanvas(document.createElement('canvas'), subUrl, { width: 180, margin: 1 }, (err, canvas) => {
    if (!err) document.getElementById('qrcode').appendChild(canvas);
});
</script>

