<div class="stats-grid">
    <div class="stat-card stat-users">
        <div class="stat-header">
            <span class="stat-icon">üë•</span>
            <span class="stat-trend"><%= t('dashboard.activeUsers') %></span>
        </div>
        <div class="stat-value"><%= stats.users.enabled %></div>
        <div class="stat-label"><%= t('common.of') %> <%= stats.users.total %> <%= t('nav.users').toLowerCase() %></div>
    </div>
    
    <div class="stat-card stat-nodes">
        <div class="stat-header">
            <span class="stat-icon">üñ•Ô∏è</span>
            <span class="stat-trend"><%= t('dashboard.onlineNodes') %></span>
        </div>
        <div class="stat-value"><%= stats.nodes.online %></div>
        <div class="stat-label"><%= t('common.of') %> <%= stats.nodes.total %> <%= t('nav.nodes').toLowerCase() %></div>
    </div>
    
    <div class="stat-card stat-online">
        <div class="stat-header">
            <span class="stat-icon">üåê</span>
            <span class="stat-trend"><%= t('common.now') %></span>
        </div>
        <div class="stat-value" id="onlineCount"><%= stats.onlineUsers %></div>
        <div class="stat-label"><%= t('common.connections') %></div>
    </div>
    
    <div class="stat-card stat-traffic">
        <div class="stat-header">
            <span class="stat-icon">üìä</span>
            <span class="stat-trend"><%= t('dashboard.total') %></span>
        </div>
        <% 
        const totalGB = (stats.traffic?.total || 0) / (1024 * 1024 * 1024);
        const txGB = (stats.traffic?.tx || 0) / (1024 * 1024 * 1024);
        const rxGB = (stats.traffic?.rx || 0) / (1024 * 1024 * 1024);
        
        const formatTraffic = (gb) => {
            if (gb >= 1000) {
                return (gb / 1024).toFixed(2) + ' TB';
            }
            return gb.toFixed(1) + ' GB';
        };
        %>
        <div class="stat-value"><%= formatTraffic(totalGB) %></div>
        <div class="stat-label" title="‚Üë <%= formatTraffic(txGB) %> / ‚Üì <%= formatTraffic(rxGB) %>">
            ‚Üë <%= formatTraffic(txGB) %> / ‚Üì <%= formatTraffic(rxGB) %>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-main">
        <!-- Nodes Status -->
<div class="card">
    <div class="card-header">
        <h2><%= t('dashboard.nodesStatus') %></h2>
                <div class="header-actions">
                    <button class="btn btn-sm" onclick="refreshStats()" title="<%= t('common.refresh') %>">üîÑ</button>
                </div>
    </div>
            <div class="card-body no-padding">
                <!-- Desktop Table -->
                <div class="table-wrapper">
                <table class="table nodes-table">
            <thead>
                <tr>
                            <th><%= t('dashboard.node') %></th>
                    <th><%= t('common.status') %></th>
                    <th><%= t('common.online') %></th>
                            <th><%= t('dashboard.load') %></th>
                            <th><%= t('dashboard.speed') %></th>
                            <th><%= t('common.actions') %></th>
                </tr>
            </thead>
            <tbody>
                <% if (nodes.length === 0) { %>
                <tr>
                            <td colspan="6" class="text-center text-muted">
                                <a href="/panel/nodes/add" class="btn btn-primary btn-sm mt-2"><%= t('dashboard.addNode') %></a>
                            </td>
                </tr>
                <% } %>
                <% nodes.forEach(node => { %>
                        <tr class="node-row" data-nodeid="<%= node._id %>">
                            <td>
                                <div class="node-cell">
                                    <strong><%= node.name %></strong>
                                    <code class="node-ip"><%= node.ip %></code>
                                </div>
                            </td>
                    <td>
                                <span class="status-indicator status-<%= node.status %>">
                                    <span class="status-dot"></span>
                            <%= node.status %>
                        </span>
                    </td>
                            <td class="online-count"><%= node.onlineUsers || 0 %><% if (node.maxOnlineUsers) { %><span class="online-limit">/<%= node.maxOnlineUsers %></span><% } %></td>
                            <td class="node-load" data-nodeid="<%= node._id %>">
                                <span class="load-placeholder">‚Äî</span>
                            </td>
                            <td class="node-speed" data-nodeid="<%= node._id %>">
                                <span class="load-placeholder">‚Äî</span>
                            </td>
                            <td>
                                <div class="node-actions">
                                    <button class="btn-icon" onclick="restartNode('<%= node._id %>')" title="<%= t('nodes.restart') %>">üîÑ</button>
                                    <a href="/panel/nodes/<%= node._id %>" class="btn-icon" title="<%= t('common.settings') %>">‚öôÔ∏è</a>
                                    <a href="/panel/nodes/<%= node._id %>/terminal" class="btn-icon" title="<%= t('nodes.terminal') %>">üíª</a>
                                </div>
                            </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
                </div>
                
                <!-- Mobile Cards -->
                <div class="mobile-nodes-list">
                    <% if (nodes.length === 0) { %>
                        <div style="text-align: center; padding: 40px 20px;">
                            <p style="color: var(--text-muted); margin-bottom: 16px;"><%= t('dashboard.noNodes') %></p>
                            <a href="/panel/nodes/add" class="btn btn-primary btn-sm"><%= t('dashboard.addNode') %></a>
                        </div>
                    <% } %>
                    <% nodes.forEach(node => { %>
                        <div class="mobile-node-card" data-nodeid="<%= node._id %>">
                            <div class="mobile-node-header">
                                <div class="mobile-node-title">
                                    <strong><%= node.name %></strong>
                                    <code><%= node.ip %></code>
                                </div>
                                <span class="status-indicator status-<%= node.status %>">
                                    <span class="status-dot"></span>
                                </span>
                            </div>
                            
                            <div class="mobile-node-stats">
                                <div class="mobile-stat-item">
                                    <span class="mobile-stat-label"><%= t('common.online') %></span>
                                    <span class="mobile-stat-value online-count"><%= node.onlineUsers || 0 %><% if (node.maxOnlineUsers) { %><span class="online-limit">/<%= node.maxOnlineUsers %></span><% } %></span>
                                </div>
                                <div class="mobile-stat-item">
                                    <span class="mobile-stat-label"><%= t('common.status') %></span>
                                    <span class="mobile-stat-value"><%= node.status %></span>
                                </div>
                                <div class="mobile-stat-item node-load-mobile" data-nodeid="<%= node._id %>">
                                    <span class="mobile-stat-label"><%= t('dashboard.load') %></span>
                                    <span class="mobile-stat-value load-placeholder">‚Äî</span>
                                </div>
                                <div class="mobile-stat-item node-speed-mobile" data-nodeid="<%= node._id %>">
                                    <span class="mobile-stat-label"><%= t('dashboard.speed') %></span>
                                    <span class="mobile-stat-value load-placeholder">‚Äî</span>
                                </div>
                            </div>
                            
                            <div class="mobile-node-actions">
                                <button class="btn btn-sm" onclick="restartNode('<%= node._id %>')" style="flex: 1;">üîÑ Restart</button>
                                <a href="/panel/nodes/<%= node._id %>" class="btn btn-sm" style="flex: 1;">‚öôÔ∏è <%= t('common.settings') %></a>
                                <a href="/panel/nodes/<%= node._id %>/terminal" class="btn-icon">üíª</a>
                            </div>
                        </div>
                    <% }); %>
                </div>
    </div>
</div>

        <!-- Logs -->
        <div class="card mt-2">
            <div class="card-header">
                <h2>
                    <span class="logs-status-dot" id="logsStatusDot"></span>
                    <%= t('dashboard.recentLogs') %>
                </h2>
                <div class="logs-controls">
                    <button class="btn btn-sm" id="logsToggleBtn" onclick="toggleLogs()" title="<%= t('dashboard.pauseLogs') %>">‚è∏Ô∏è</button>
                    <button class="btn btn-sm" onclick="clearLogs()" title="<%= t('common.clear') %>">üóëÔ∏è</button>
                </div>
            </div>
            <div class="card-body no-padding">
                <div class="logs-container" id="logsContainer">
                    <div class="logs-loading"><%= t('common.loading') %></div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-sidebar">
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h2><%= t('dashboard.quickActions') %></h2>
            </div>
            <div class="card-body">
                <div class="quick-actions">
                    <a href="/panel/nodes/add" class="quick-action">
                        <span class="qa-icon">‚ûï</span>
                        <span class="qa-text"><%= t('dashboard.addNode') %></span>
                    </a>
                    <a href="/panel/users/add" class="quick-action">
                        <span class="qa-icon">üë§</span>
                        <span class="qa-text"><%= t('dashboard.addUser') %></span>
                    </a>
                    <a href="/panel/stats" class="quick-action">
                        <span class="qa-icon">üìä</span>
                        <span class="qa-text"><%= t('nav.stats') %></span>
                    </a>
                    <button class="quick-action" onclick="createBackup()">
                        <span class="qa-icon">üíæ</span>
                        <span class="qa-text"><%= t('dashboard.backupDb') %></span>
                    </button>
                    <button class="quick-action" onclick="document.getElementById('restoreInput').click()">
                        <span class="qa-icon">üì•</span>
                        <span class="qa-text"><%= t('dashboard.restoreDb') %></span>
                    </button>
                    <input type="file" id="restoreInput" accept=".tar.gz,.tgz" style="display:none" onchange="restoreBackup(this)">
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card mt-2">
            <div class="card-header">
                <h2><%= t('dashboard.panel') %></h2>
                <button class="btn btn-sm" onclick="loadSystemStats()" title="<%= t('common.refresh') %>">üîÑ</button>
            </div>
            <div class="card-body">
                <div class="system-info" id="systemStats">
                    <div class="sys-item">
                        <span class="sys-label">CPU</span>
                        <div class="progress-bar-wrap">
                            <div class="progress-bar" id="cpuBar" style="width: 0%"></div>
                        </div>
                        <span class="sys-value" id="cpuValue">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">RAM</span>
                        <div class="progress-bar-wrap">
                            <div class="progress-bar" id="ramBar" style="width: 0%"></div>
                        </div>
                        <span class="sys-value" id="ramValue">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">RPS</span>
                        <span class="sys-value" id="rpsValue">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">Connections</span>
                        <span class="sys-value" id="connectionsValue">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">Redis Keys</span>
                        <span class="sys-value" id="cacheValue">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">Process</span>
                        <span class="sys-value" id="processValue">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">Uptime</span>
                        <span class="sys-value" id="uptime">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<style>
/* Real-time logs status indicator */
.logs-status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
    background: var(--text-muted);
}
.logs-status-dot.connecting {
    background: var(--warning);
    animation: pulse 1s infinite;
}
.logs-status-dot.connected {
    background: var(--success);
    box-shadow: 0 0 8px var(--success);
}
.logs-status-dot.disconnected,
.logs-status-dot.error {
    background: var(--danger);
}
.logs-controls {
    display: flex;
    gap: 8px;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.progress-bar-wrap {
    width: 60px;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    margin: 4px 0;
}
.progress-bar {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    transition: width 0.3s;
}
.progress-bar.high { background: #ef4444; }
.progress-bar.medium { background: #f59e0b; }
.node-load {
    font-size: 0.8rem;
    color: var(--muted);
}
.node-load .cpu, .node-load .mem {
    display: block;
}
.node-speed {
    font-size: 0.8rem;
    color: var(--muted);
}
.node-speed .speed-up, .node-speed .speed-down {
    display: block;
}
.node-speed .speed-up {
    color: #22c55e;
}
.node-speed .speed-down {
    color: #3b82f6;
}
.load-placeholder {
    color: var(--muted);
}
.online-limit {
    color: var(--text-muted);
    font-size: 0.85em;
}
</style>

<script>
const i18n = {
    noLogs: <%- JSON.stringify(t("dashboard.noLogs")) %>,
    loadError: <%- JSON.stringify(t("dashboard.loadError")) %>,
    error: <%- JSON.stringify(t("common.error")) %>,
    nodeRestarted: <%- JSON.stringify(t("dashboard.nodeRestarted")) %>,
    restartError: <%- JSON.stringify(t("dashboard.restartError")) %>,
    creatingBackup: <%- JSON.stringify(t("dashboard.creatingBackup")) %>,
    backupDownloaded: <%- JSON.stringify(t("dashboard.backupDownloaded")) %>,
    backupError: <%- JSON.stringify(t("dashboard.backupError")) %>,
    restoringDb: <%- JSON.stringify(t("dashboard.restoringDb")) %>,
    dbRestored: <%- JSON.stringify(t("dashboard.dbRestored")) %>,
    restoreConfirm: <%- JSON.stringify(t("dashboard.restoreConfirm")) %>
};

// Logs WebSocket
let logsWs = null;
let logsPaused = false;
let logsAutoScroll = true;

// Load on page load
document.addEventListener('DOMContentLoaded', () => {
    connectLogsWebSocket();
    loadSystemStats();
    loadNodesStats();
    loadNodesSpeed();
});

function connectLogsWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/logs`;
    
    updateLogsStatus('connecting');
    
    logsWs = new WebSocket(wsUrl);
    
    logsWs.onopen = () => {
        updateLogsStatus('connected');
    };
    
    logsWs.onmessage = (event) => {
        if (logsPaused) return;
        
        const msg = JSON.parse(event.data);
        
        if (msg.type === 'history') {
            // Initial history load
            const container = document.getElementById('logsContainer');
            if (msg.logs && msg.logs.length > 0) {
                container.innerHTML = msg.logs.map(log => formatLogLine(log)).join('');
                scrollLogsToBottom();
            } else {
                container.innerHTML = '<div class="logs-empty">' + i18n.noLogs + '</div>';
            }
        } else if (msg.type === 'log') {
            // New real-time log
            appendLog(msg);
        }
    };
    
    logsWs.onclose = () => {
        updateLogsStatus('disconnected');
        // Reconnect after 3 seconds
        setTimeout(connectLogsWebSocket, 3000);
    };
    
    logsWs.onerror = () => {
        updateLogsStatus('error');
    };
}

function formatLogLine(log) {
    const level = log.level || 'info';
    const message = `${log.timestamp} [${level.toUpperCase()}]: ${log.message}`;
    let cls = 'log-line';
    if (level === 'error') cls += ' log-error';
    else if (level === 'warn') cls += ' log-warn';
    else if (message.includes('‚úÖ') || message.includes('‚úì')) cls += ' log-success';
    return `<div class="${cls}">${escapeHtml(message)}</div>`;
}

function appendLog(log) {
    const container = document.getElementById('logsContainer');
    
    // Remove "no logs" message if present
    const emptyMsg = container.querySelector('.logs-empty');
    if (emptyMsg) emptyMsg.remove();
    
    // Add new log at top (newest first)
    const logHtml = formatLogLine(log);
    container.insertAdjacentHTML('afterbegin', logHtml);
    
    // Keep only last 100 logs in DOM
    const lines = container.querySelectorAll('.log-line');
    if (lines.length > 100) {
        lines[lines.length - 1].remove();
    }
}

function scrollLogsToBottom() {
    if (logsAutoScroll) {
        const container = document.getElementById('logsContainer');
        container.scrollTop = 0; // Newest are at top
    }
}

function updateLogsStatus(status) {
    const dot = document.getElementById('logsStatusDot');
    dot.className = 'logs-status-dot ' + status;
}

function toggleLogs() {
    logsPaused = !logsPaused;
    const btn = document.getElementById('logsToggleBtn');
    btn.textContent = logsPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
    btn.title = logsPaused ? 'Resume' : 'Pause';
}

function clearLogs() {
    document.getElementById('logsContainer').innerHTML = '<div class="logs-empty">' + i18n.noLogs + '</div>';
}

function escapeHtml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

async function loadSystemStats() {
    try {
        const res = await fetch('/panel/system-stats', { credentials: 'include' });
        const data = await res.json();
        
        if (data.success) {
            // CPU –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
            const cpuPercent = data.cpu.percent || 0;
            const cpuBar = document.getElementById('cpuBar');
            cpuBar.style.width = cpuPercent + '%';
            cpuBar.className = 'progress-bar' + (cpuPercent > 80 ? ' high' : cpuPercent > 60 ? ' medium' : '');
            document.getElementById('cpuValue').textContent = cpuPercent + '%';
            
            // RAM
            const ramPercent = data.mem.percent;
            const ramBar = document.getElementById('ramBar');
            ramBar.style.width = ramPercent + '%';
            ramBar.className = 'progress-bar' + (ramPercent > 80 ? ' high' : ramPercent > 60 ? ' medium' : '');
            document.getElementById('ramValue').textContent = ramPercent + '%';
            
            // RPS (Requests Per Second)
            const rps = data.requests?.rps || 0;
            const rpm = data.requests?.rpm || 0;
            document.getElementById('rpsValue').textContent = `${rps}/s (${rpm}/m)`;
            
            // Active connections
            document.getElementById('connectionsValue').textContent = data.connections || 0;
            
            // Cache (Redis keys)
            const cacheKeys = data.cache?.keys || 0;
            const cacheMem = data.cache?.usedMemoryMB || '0';
            document.getElementById('cacheValue').textContent = `${cacheKeys} (${cacheMem}MB)`;
            
            // Process memory
            const processMB = Math.round(data.process.rss / 1024 / 1024);
            document.getElementById('processValue').textContent = processMB + ' MB';
            
            // Uptime
            const uptime = data.uptime;
            const hours = Math.floor(uptime / 3600);
            const mins = Math.floor((uptime % 3600) / 60);
            document.getElementById('uptime').textContent = `${hours}h ${mins}m`;
        }
    } catch (e) {
        console.error('Failed to load system stats:', e);
    }
}

async function loadNodesStats() {
    const renderStats = (data, desktopEl, mobileEl) => {
        if (data.success) {
            const cpuPercent = Math.min(Math.round((data.cpu.load1 / data.cpu.cores) * 100), 100);
            const memPercent = data.mem.percent;
            
            let cpuColor = 'var(--text-primary)';
            if (cpuPercent >= 80) cpuColor = '#ef4444';
            else if (cpuPercent >= 60) cpuColor = '#f59e0b';
            
            if (desktopEl) {
                desktopEl.innerHTML = `
                    <span class="cpu" style="color: ${cpuColor}">CPU: ${cpuPercent}%</span>
                    <span class="mem">RAM: ${memPercent}%</span>
                `;
            }
            if (mobileEl) {
                mobileEl.innerHTML = `<span style="color: ${cpuColor}">${cpuPercent}%</span> / ${memPercent}%`;
            }
        } else {
            if (desktopEl) desktopEl.innerHTML = '<span class="load-placeholder">N/A</span>';
            if (mobileEl) mobileEl.textContent = 'N/A';
        }
    };
    
    // Collect unique nodeIds with their elements
    const nodesMap = new Map();
    
    document.querySelectorAll('.node-row').forEach(row => {
        const nodeId = row.dataset.nodeid;
        if (!nodesMap.has(nodeId)) nodesMap.set(nodeId, { desktop: null, mobile: null });
        nodesMap.get(nodeId).desktop = row.querySelector('.node-load');
    });
    
    document.querySelectorAll('.node-load-mobile').forEach(card => {
        const nodeId = card.dataset.nodeid;
        if (!nodesMap.has(nodeId)) nodesMap.set(nodeId, { desktop: null, mobile: null });
        nodesMap.get(nodeId).mobile = card.querySelector('.mobile-stat-value');
    });
    
    // One request per node, parallel execution
    const tasks = Array.from(nodesMap.entries()).map(([nodeId, elements]) => 
        fetch(`/panel/nodes/${nodeId}/stats`, { credentials: 'include' })
            .then(res => res.json())
            .then(data => renderStats(data, elements.desktop, elements.mobile))
            .catch(() => {
                if (elements.desktop) elements.desktop.innerHTML = '<span class="load-placeholder">‚Äî</span>';
                if (elements.mobile) elements.mobile.textContent = '‚Äî';
            })
    );
    
    await Promise.all(tasks);
}

async function loadNodesSpeed() {
    const formatSpeed = (bytes) => {
        const bits = bytes * 8;
        if (bits < 1000) return `${bits.toFixed(0)} bit/s`;
        if (bits < 1000 * 1000) return `${(bits / 1000).toFixed(1)} Kbit/s`;
        if (bits < 1000 * 1000 * 1000) return `${(bits / 1000 / 1000).toFixed(1)} Mbit/s`;
        return `${(bits / 1000 / 1000 / 1000).toFixed(2)} Gbit/s`;
    };
    
    const renderSpeed = (data, desktopEl, mobileEl) => {
        if (data.success) {
            const txSpeed = formatSpeed(data.tx);
            const rxSpeed = formatSpeed(data.rx);
            
            if (desktopEl) {
                desktopEl.innerHTML = `
                    <span class="speed-up" title="Upload">‚Üë ${txSpeed}</span>
                    <span class="speed-down" title="Download">‚Üì ${rxSpeed}</span>
                `;
            }
            if (mobileEl) {
                mobileEl.innerHTML = `
                    <span style="color: #22c55e; font-size: 12px;">‚Üë ${txSpeed}</span><br>
                    <span style="color: #3b82f6; font-size: 12px;">‚Üì ${rxSpeed}</span>
                `;
            }
        } else {
            if (desktopEl) desktopEl.innerHTML = '<span class="load-placeholder">N/A</span>';
            if (mobileEl) mobileEl.textContent = 'N/A';
        }
    };
    
    // Collect unique nodeIds with their elements
    const nodesMap = new Map();
    
    document.querySelectorAll('.node-row').forEach(row => {
        const nodeId = row.dataset.nodeid;
        if (!nodesMap.has(nodeId)) nodesMap.set(nodeId, { desktop: null, mobile: null });
        const el = row.querySelector('.node-speed');
        el.innerHTML = '<span class="load-placeholder">‚è≥</span>';
        nodesMap.get(nodeId).desktop = el;
    });
    
    document.querySelectorAll('.node-speed-mobile').forEach(card => {
        const nodeId = card.dataset.nodeid;
        if (!nodesMap.has(nodeId)) nodesMap.set(nodeId, { desktop: null, mobile: null });
        const el = card.querySelector('.mobile-stat-value');
        el.textContent = '‚è≥';
        nodesMap.get(nodeId).mobile = el;
    });
    
    // One request per node, parallel execution
    const tasks = Array.from(nodesMap.entries()).map(([nodeId, elements]) => 
        fetch(`/panel/nodes/${nodeId}/speed`, { credentials: 'include' })
            .then(res => res.json())
            .then(data => renderSpeed(data, elements.desktop, elements.mobile))
            .catch(() => {
                if (elements.desktop) elements.desktop.innerHTML = '<span class="load-placeholder">‚Äî</span>';
                if (elements.mobile) elements.mobile.textContent = '‚Äî';
            })
    );
    
    await Promise.all(tasks);
}

async function refreshStats() {
    location.reload();
}

async function restartNode(nodeId) {
    const row = document.querySelector(`tr[data-nodeid="${nodeId}"]`);
    const btn = row.querySelector('.btn-icon');
    btn.disabled = true;
    btn.textContent = '‚è≥';
    
    try {
        const res = await fetch(`/panel/nodes/${nodeId}/restart`, { 
            method: 'POST', 
            credentials: 'include' 
        });
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.nodeRestarted);
            row.querySelector('.status-indicator').className = 'status-indicator status-online';
            row.querySelector('.status-indicator').innerHTML = '<span class="status-dot"></span>online';
        } else {
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
        }
    } catch (e) {
        showToast(i18n.restartError, 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'üîÑ';
}

async function createBackup() {
    showToast(i18n.creatingBackup);
    try {
        const res = await fetch('/panel/backup', { 
            method: 'POST', 
            credentials: 'include' 
        });
        
        if (!res.ok) {
            const data = await res.json();
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
            return;
        }
        
        const blob = await res.blob();
        const contentDisposition = res.headers.get('Content-Disposition');
        let filename = 'backup.tar.gz';
        if (contentDisposition) {
            const match = contentDisposition.match(/filename="?([^";\n]+)"?/);
            if (match) filename = match[1];
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast(i18n.backupDownloaded);
    } catch (e) {
        showToast(i18n.backupError, 'error');
    }
}

async function restoreBackup(input) {
    const file = input.files[0];
    if (!file) return;
    
    const confirmMsg = i18n.restoreConfirm.replace('{filename}', file.name);
    if (!confirm(confirmMsg)) {
        input.value = '';
        return;
    }
    
    showToast(i18n.restoringDb);
    
    const formData = new FormData();
    formData.append('backup', file);
    
    try {
        const res = await fetch('/panel/restore', { 
            method: 'POST', 
            credentials: 'include',
            body: formData
        });
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.dbRestored);
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
        }
    } catch (e) {
        showToast(i18n.error + ' restore', 'error');
    }
    
    input.value = '';
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 3000);
}
</script>
