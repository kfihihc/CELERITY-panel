<div class="stats-grid">
    <div class="stat-card stat-users">
        <div class="stat-header">
            <span class="stat-icon">üë•</span>
            <span class="stat-trend">–∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
        </div>
        <div class="stat-value"><%= stats.users.enabled %></div>
        <div class="stat-label">–∏–∑ <%= stats.users.total %> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
    </div>
    
    <div class="stat-card stat-nodes">
        <div class="stat-header">
            <span class="stat-icon">üñ•Ô∏è</span>
            <span class="stat-trend">–æ–Ω–ª–∞–π–Ω</span>
        </div>
        <div class="stat-value"><%= stats.nodes.online %></div>
        <div class="stat-label">–∏–∑ <%= stats.nodes.total %> –Ω–æ–¥</div>
    </div>
    
    <div class="stat-card stat-online">
        <div class="stat-header">
            <span class="stat-icon">üåê</span>
            <span class="stat-trend">—Å–µ–π—á–∞—Å</span>
        </div>
        <div class="stat-value" id="onlineCount"><%= stats.onlineUsers %></div>
        <div class="stat-label">–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</div>
    </div>
    
    <div class="stat-card stat-sync">
        <div class="stat-header">
            <span class="stat-icon">‚è±Ô∏è</span>
            <span class="stat-trend">sync</span>
        </div>
        <div class="stat-value"><%= stats.lastSync ? new Date(stats.lastSync).toLocaleTimeString('ru', {hour: '2-digit', minute: '2-digit'}) : '‚Äî' %></div>
        <div class="stat-label">–ø–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞</div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-main">
        <!-- Nodes Status -->
<div class="card">
    <div class="card-header">
        <h2>–°—Ç–∞—Ç—É—Å –Ω–æ–¥</h2>
                <div class="header-actions">
                    <button class="btn btn-sm" onclick="refreshStats()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
                </div>
    </div>
            <div class="card-body no-padding">
                <table class="table nodes-table">
            <thead>
                <tr>
                            <th>–ù–æ–¥–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–û–Ω–ª–∞–π–Ω</th>
                            <th>–ó–∞–≥—Ä—É–∑–∫–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                <% if (nodes.length === 0) { %>
                <tr>
                            <td colspan="5" class="text-center text-muted">
                                <a href="/panel/nodes/add" class="btn btn-primary btn-sm mt-2">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—É</a>
                            </td>
                </tr>
                <% } %>
                <% nodes.forEach(node => { %>
                        <tr class="node-row" data-nodeid="<%= node._id %>">
                            <td>
                                <div class="node-cell">
                                    <strong><%= node.name %></strong>
                                    <code class="node-ip"><%= node.ip %></code>
                                </div>
                            </td>
                    <td>
                                <span class="status-indicator status-<%= node.status %>">
                                    <span class="status-dot"></span>
                            <%= node.status %>
                        </span>
                    </td>
                            <td class="online-count"><%= node.onlineUsers || 0 %></td>
                            <td class="node-load" data-nodeid="<%= node._id %>">
                                <span class="load-placeholder">‚Äî</span>
                            </td>
                            <td>
                                <div class="node-actions">
                                    <button class="btn-icon" onclick="restartNode('<%= node._id %>')" title="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å">üîÑ</button>
                                    <a href="/panel/nodes/<%= node._id %>" class="btn-icon" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</a>
                                    <a href="/panel/nodes/<%= node._id %>/terminal" class="btn-icon" title="–¢–µ—Ä–º–∏–Ω–∞–ª">üíª</a>
                                </div>
                            </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

        <!-- Logs -->
        <div class="card mt-2">
            <div class="card-header">
                <h2>–õ–æ–≥–∏</h2>
                <button class="btn btn-sm" onclick="refreshLogs()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div class="card-body no-padding">
                <div class="logs-container" id="logsContainer">
                    <div class="logs-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-sidebar">
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h2>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            </div>
            <div class="card-body">
                <div class="quick-actions">
                    <a href="/panel/nodes/add" class="quick-action">
                        <span class="qa-icon">‚ûï</span>
                        <span class="qa-text">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—É</span>
                    </a>
                    <a href="/panel/users/add" class="quick-action">
                        <span class="qa-icon">üë§</span>
                        <span class="qa-text">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                    </a>
                    <button class="quick-action" onclick="syncAll()">
                        <span class="qa-icon">üîÑ</span>
                        <span class="qa-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span>
                    </button>
                    <button class="quick-action" onclick="createBackup()">
                        <span class="qa-icon">üíæ</span>
                        <span class="qa-text">Backup –ë–î</span>
                    </button>
                    <button class="quick-action" onclick="document.getElementById('restoreInput').click()">
                        <span class="qa-icon">üì•</span>
                        <span class="qa-text">Restore –ë–î</span>
                    </button>
                    <input type="file" id="restoreInput" accept=".tar.gz,.tgz" style="display:none" onchange="restoreBackup(this)">
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card mt-2">
            <div class="card-header">
                <h2>–ü–∞–Ω–µ–ª—å</h2>
                <button class="btn btn-sm" onclick="loadSystemStats()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
            </div>
            <div class="card-body">
                <div class="system-info" id="systemStats">
                    <div class="sys-item">
                        <span class="sys-label">CPU Load</span>
                        <span class="sys-value" id="cpuLoad">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">RAM</span>
                        <div class="progress-bar-wrap">
                            <div class="progress-bar" id="ramBar" style="width: 0%"></div>
                        </div>
                        <span class="sys-value" id="ramValue">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">Process</span>
                        <span class="sys-value" id="processValue">‚Äî</span>
                    </div>
                    <div class="sys-item">
                        <span class="sys-label">Uptime</span>
                        <span class="sys-value" id="uptime">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<style>
.progress-bar-wrap {
    width: 60px;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    margin: 4px 0;
}
.progress-bar {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    transition: width 0.3s;
}
.progress-bar.high { background: #ef4444; }
.progress-bar.medium { background: #f59e0b; }
.node-load {
    font-size: 0.8rem;
    color: var(--muted);
}
.node-load .cpu, .node-load .mem {
    display: block;
}
.load-placeholder {
    color: var(--muted);
}
</style>

<script>
// Load on page load
document.addEventListener('DOMContentLoaded', () => {
    refreshLogs();
    loadSystemStats();
    loadNodesStats();
});

async function refreshLogs() {
    try {
        const res = await fetch('/panel/logs', { credentials: 'include' });
        const data = await res.json();
        
        const container = document.getElementById('logsContainer');
        if (data.logs && data.logs.length > 0) {
            container.innerHTML = data.logs.map(log => {
                const isError = log.includes('error') || log.includes('Error') || log.includes('‚ùå');
                const isWarn = log.includes('warn') || log.includes('‚ö†');
                const isSuccess = log.includes('‚úÖ') || log.includes('‚úì');
                let cls = 'log-line';
                if (isError) cls += ' log-error';
                else if (isWarn) cls += ' log-warn';
                else if (isSuccess) cls += ' log-success';
                return `<div class="${cls}">${escapeHtml(log)}</div>`;
            }).join('');
        } else {
            container.innerHTML = '<div class="logs-empty">–ù–µ—Ç –ª–æ–≥–æ–≤</div>';
        }
    } catch (e) {
        document.getElementById('logsContainer').innerHTML = '<div class="logs-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
    }
}

function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

async function loadSystemStats() {
    try {
        const res = await fetch('/panel/system-stats', { credentials: 'include' });
        const data = await res.json();
        
        if (data.success) {
            // CPU
            document.getElementById('cpuLoad').textContent = data.cpu.load1.toFixed(2);
            
            // RAM
            const ramPercent = data.mem.percent;
            const ramBar = document.getElementById('ramBar');
            ramBar.style.width = ramPercent + '%';
            ramBar.className = 'progress-bar' + (ramPercent > 80 ? ' high' : ramPercent > 60 ? ' medium' : '');
            document.getElementById('ramValue').textContent = ramPercent + '%';
            
            // Process memory
            const processMB = Math.round(data.process.rss / 1024 / 1024);
            document.getElementById('processValue').textContent = processMB + ' MB';
            
            // Uptime
            const uptime = data.uptime;
            const hours = Math.floor(uptime / 3600);
            const mins = Math.floor((uptime % 3600) / 60);
            document.getElementById('uptime').textContent = `${hours}—á ${mins}–º`;
        }
    } catch (e) {
        console.error('Failed to load system stats:', e);
    }
}

async function loadNodesStats() {
    const nodeRows = document.querySelectorAll('.node-row');
    
    for (const row of nodeRows) {
        const nodeId = row.dataset.nodeid;
        const loadCell = row.querySelector('.node-load');
        
        try {
            const res = await fetch(`/panel/nodes/${nodeId}/stats`, { credentials: 'include' });
            const data = await res.json();
            
            if (data.success) {
                const cpuLoad = data.cpu.load1.toFixed(1);
                const memPercent = data.mem.percent;
                
                loadCell.innerHTML = `
                    <span class="cpu">CPU: ${cpuLoad}</span>
                    <span class="mem">RAM: ${memPercent}%</span>
                `;
            } else {
                loadCell.innerHTML = '<span class="load-placeholder">N/A</span>';
            }
        } catch (e) {
            loadCell.innerHTML = '<span class="load-placeholder">‚Äî</span>';
        }
    }
}

async function refreshStats() {
    location.reload();
}

async function syncAll() {
    showToast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞...');
    try {
        await fetch('/api/sync', { method: 'POST', credentials: 'include' });
        showToast('‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞', 'error');
    }
}

async function restartNode(nodeId) {
    const row = document.querySelector(`tr[data-nodeid="${nodeId}"]`);
    const btn = row.querySelector('.btn-icon');
    btn.disabled = true;
    btn.textContent = '‚è≥';
    
    try {
        const res = await fetch(`/panel/nodes/${nodeId}/restart`, { 
            method: 'POST', 
            credentials: 'include' 
        });
        const data = await res.json();
        
        if (data.success) {
            showToast('‚úì –ù–æ–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞');
            row.querySelector('.status-indicator').className = 'status-indicator status-online';
            row.querySelector('.status-indicator').innerHTML = '<span class="status-dot"></span>online';
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (data.error || 'unknown'), 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞', 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'üîÑ';
}

async function createBackup() {
    showToast('–°–æ–∑–¥–∞–Ω–∏–µ backup...');
    try {
        const res = await fetch('/panel/backup', { 
            method: 'POST', 
            credentials: 'include' 
        });
        
        if (!res.ok) {
            const data = await res.json();
            showToast('–û—à–∏–±–∫–∞: ' + (data.error || 'unknown'), 'error');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
        const blob = await res.blob();
        const contentDisposition = res.headers.get('Content-Disposition');
        let filename = 'backup.tar.gz';
        if (contentDisposition) {
            const match = contentDisposition.match(/filename="?([^";\n]+)"?/);
            if (match) filename = match[1];
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast('‚úì Backup —Å–∫–∞—á–∞–Ω');
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞ backup', 'error');
    }
}

async function restoreBackup(input) {
    const file = input.files[0];
    if (!file) return;
    
    if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ "${file.name}"?\n\n‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã!`)) {
        input.value = '';
        return;
    }
    
    showToast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î...');
    
    const formData = new FormData();
    formData.append('backup', file);
    
    try {
        const res = await fetch('/panel/restore', { 
            method: 'POST', 
            credentials: 'include',
            body: formData
        });
        const data = await res.json();
        
        if (data.success) {
            showToast('‚úì –ë–î –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (data.error || 'unknown'), 'error');
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞ restore', 'error');
    }
    
    input.value = '';
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 3000);
}
</script>
