<% if (message) { %>
<div class="alert alert-success"><%= message %></div>
<% } %>
<% if (error) { %>
<div class="alert alert-error"><%= error %></div>
<% } %>

<div class="row">
    <div class="col-6">
        <div class="card">
            <div class="card-header">
                <h2>–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            </div>
            <div class="card-body">
                <div class="settings-list">
                    <div class="setting-item">
                        <label>Base URL</label>
                        <code><%= config.BASE_URL %></code>
                    </div>
                    <div class="setting-item">
                        <label>–ü–æ—Ä—Ç</label>
                        <code><%= config.PORT %></code>
                    </div>
                    <div class="setting-item">
                        <label>MongoDB</label>
                        <code><%= config.MONGO_URI.replace(/\/\/.*@/, '//***@') %></code>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
            </div>
            <div class="card-body">
                <form method="POST" action="/panel/settings">
                    
                    <h4 style="margin-bottom: 0.75rem;">‚öñÔ∏è –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏</h4>
                    <div class="settings-list" style="margin-bottom: 1.5rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" name="loadBalancing.enabled" 
                                   <%= settings?.loadBalancing?.enabled ? 'checked' : '' %>>
                            <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∑–∞–≥—Ä—É–∑–∫–µ</span>
                        </label>
                        <small class="hint" style="display: block; margin-top: 0.25rem;">
                            –ú–µ–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –Ω–æ–¥—ã –±—É–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏ –≤ –ø–æ–¥–ø–∏—Å–∫–µ
                        </small>
                        
                        <label class="checkbox-label" style="margin-top: 0.75rem;">
                            <input type="checkbox" name="loadBalancing.hideOverloaded" 
                                   <%= settings?.loadBalancing?.hideOverloaded ? 'checked' : '' %>>
                            <span>–°–∫—Ä—ã–≤–∞—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–µ</span>
                        </label>
                        <small class="hint" style="display: block; margin-top: 0.25rem;">
                            –ù–æ–¥—ã —Å –æ–Ω–ª–∞–π–Ω ‚â• –ª–∏–º–∏—Ç—É –Ω–µ –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –≤ –ø–æ–¥–ø–∏—Å–∫—É
                        </small>
                    </div>
                    
                    <hr style="margin: 1rem 0; border-color: var(--border);">
                    
                    <h4 style="margin-bottom: 0.75rem;">üì± –õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h4>
                    <div class="settings-grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="deviceGracePeriod">Grace Period (–º–∏–Ω)</label>
                            <input type="number" name="deviceGracePeriod" id="deviceGracePeriod" 
                                   value="<%= settings?.deviceGracePeriod ?? 15 %>" min="1" max="60">
                            <small class="hint">–ö–∞–∫ –¥–æ–ª–≥–æ –ø–æ–º–Ω–∏—Ç—å IP –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è. –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –ø—Ä–∏ —Å–º–µ–Ω–µ WiFi‚ÜîLTE</small>
                        </div>
                    </div>
                    <div class="alert" style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 12px; font-size: 13px;">
                        <strong>‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º IP-–∞–¥—Ä–µ—Å–∞–º. 
                        –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Å –Ω–æ–≤–æ–≥–æ IP, –∞ —Å—Ç–∞—Ä—ã–π –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –º–µ–Ω–µ–µ <%= settings?.deviceGracePeriod ?? 15 %> –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥ ‚Äî 
                        –æ–±–∞ IP —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ –ª–∏–º–∏—Ç–µ.
                    </div>
                    
                    <hr style="margin: 1rem 0; border-color: var(--border);">
                    
                    <h4 style="margin-bottom: 0.75rem;">üöÄ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)</h4>
                    <div class="settings-grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="cache.subscriptionTTL">–ü–æ–¥–ø–∏—Å–∫–∏ (—Å–µ–∫)</label>
                            <input type="number" name="cache.subscriptionTTL" id="cache.subscriptionTTL" 
                                   value="<%= settings?.cache?.subscriptionTTL || 3600 %>" min="60" max="86400">
                            <small class="hint">–ì–æ—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏. –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–æ–¥</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="cache.userTTL">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Å–µ–∫)</label>
                            <input type="number" name="cache.userTTL" id="cache.userTTL" 
                                   value="<%= settings?.cache?.userTTL || 900 %>" min="60" max="3600">
                            <small class="hint">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="cache.onlineSessionsTTL">–û–Ω–ª–∞–π–Ω-—Å–µ—Å—Å–∏–∏ (—Å–µ–∫)</label>
                            <input type="number" name="cache.onlineSessionsTTL" id="cache.onlineSessionsTTL" 
                                   value="<%= settings?.cache?.onlineSessionsTTL || 10 %>" min="5" max="60">
                            <small class="hint">–î–ª—è –ª–∏–º–∏—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –ú–µ–Ω—å—à–µ = —Ç–æ—á–Ω–µ–µ</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="cache.activeNodesTTL">–ê–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–¥—ã (—Å–µ–∫)</label>
                            <input type="number" name="cache.activeNodesTTL" id="cache.activeNodesTTL" 
                                   value="<%= settings?.cache?.activeNodesTTL || 30 %>" min="10" max="300">
                            <small class="hint">–ë—ã—Å—Ç—Ä–µ–µ —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–æ–¥</small>
                        </div>
                    </div>
                    
                    <hr style="margin: 1rem 0; border-color: var(--border);">
                    
                    <h4 style="margin-bottom: 0.75rem;">üõ°Ô∏è Rate Limiting</h4>
                    <div class="settings-grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="rateLimit.subscriptionPerMinute">–ü–æ–¥–ø–∏—Å–∫–∏/–º–∏–Ω –Ω–∞ IP</label>
                            <input type="number" name="rateLimit.subscriptionPerMinute" id="rateLimit.subscriptionPerMinute" 
                                   value="<%= settings?.rateLimit?.subscriptionPerMinute || 100 %>" min="10" max="1000">
                            <small class="hint">–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤. –ù–æ—Ä–º–∞: 60-100</small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-6">
        <div class="card">
            <div class="card-header">
                <h2>üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
            </div>
            <div class="card-body">
                <div class="settings-list">
                    <div class="setting-item">
                        <label>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</label>
                        <span><%= admin?.username || 'N/A' %></span>
                    </div>
                    <div class="setting-item">
                        <label>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</label>
                        <span><%= admin?.lastLogin ? new Date(admin.lastLogin).toLocaleString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞' %></span>
                    </div>
                    <div class="setting-item">
                        <label>IP Whitelist</label>
                        <span><%= config.PANEL_IP_WHITELIST || '–û—Ç–∫–ª—é—á–µ–Ω (–¥–æ—Å—Ç—É–ø –≤—Å–µ–º)' %></span>
                    </div>
                </div>
                
                <hr style="margin: 1rem 0; border-color: var(--border);">
                
                <h4 style="margin-bottom: 0.5rem;">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h4>
                <form method="POST" action="/panel/settings/password" class="compact-form">
                    <div class="form-group">
                        <input type="password" name="currentPassword" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" required>
                    </div>
                    <div class="form-group">
                        <input type="password" name="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <input type="password" name="confirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è" minlength="6" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                </form>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2>SSL –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</h2>
            </div>
            <div class="card-body">
                <% if (ssl.enabled) { %>
                <div class="alert alert-success">
                    <strong>‚úÖ HTTPS –∞–∫—Ç–∏–≤–µ–Ω</strong>
                    <p>–î–æ–º–µ–Ω: <%= ssl.domain %></p>
                    <p>Let's Encrypt –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</p>
                </div>
                <% } else { %>
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è HTTP —Ä–µ–∂–∏–º</strong>
                    <p>–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è HTTPS –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:</p>
                    <pre>PANEL_DOMAIN=panel.example.com
ACME_EMAIL=admin@example.com</pre>
                </div>
                <% } %>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>
            </div>
            <div class="card-body">
                <div class="settings-list">
                    <div class="setting-item">
                        <label>Uptime</label>
                        <span><%= Math.floor(process.uptime() / 3600) %>h <%= Math.floor((process.uptime() % 3600) / 60) %>m</span>
                    </div>
                    <div class="setting-item">
                        <label>Memory</label>
                        <span><%= Math.round(process.memoryUsage().heapUsed / 1024 / 1024) %> MB</span>
                    </div>
                    <div class="setting-item">
                        <label>Node.js</label>
                        <span><%= process.version %></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2>‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h2>
            </div>
            <div class="card-body">
                <h4 style="margin-bottom: 0.5rem;">–°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞</h4>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 1rem;">
                    –û–±–Ω—É–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ (tx/rx) –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. 
                    –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!
                </p>
                <button class="btn btn-danger btn-sm" onclick="resetTraffic()">
                    üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫
                </button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
async function resetTraffic() {
    if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        return;
    }
    
    // –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (!confirm('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.\n\n–°—á–µ—Ç—á–∏–∫–∏ tx/rx –±—É–¥—É—Ç –æ–±–Ω—É–ª–µ–Ω—ã —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ –°–±—Ä–æ—Å...';
    
    try {
        const res = await fetch('/panel/settings/reset-traffic', {
            method: 'POST',
            credentials: 'include'
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(`‚úì –¢—Ä–∞—Ñ–∏–∫ —Å–±—Ä–æ—à–µ–Ω —É ${data.count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('–û—à–∏–±–∫–∞: ' + (data.error || 'unknown'), 'error');
            btn.disabled = false;
            btn.textContent = 'üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫';
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞', 'error');
        btn.disabled = false;
        btn.textContent = 'üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫';
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 3000);
}
</script>

