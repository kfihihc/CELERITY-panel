<% if (message) { %>
<div class="alert alert-success"><%= message %></div>
<% } %>
<% if (error) { %>
<div class="alert alert-error"><%= error %></div>
<% } %>

<style>
.settings-tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--border);
    margin-bottom: 1.5rem;
    overflow-x: auto;
}
.settings-tab {
    padding: 0.75rem 1.25rem;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}
.settings-tab:hover {
    color: var(--text);
    background: var(--bg-tertiary);
}
.settings-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
.settings-section {
    margin-bottom: 1.5rem;
}
.settings-section:last-child {
    margin-bottom: 0;
}
.section-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
}
</style>

<div class="settings-tabs">
    <button class="settings-tab active" data-tab="system">‚öôÔ∏è <%= t('settings.tabSystem') || '–°–∏—Å—Ç–µ–º–∞' %></button>
    <button class="settings-tab" data-tab="security">üîê <%= t('settings.tabSecurity') || '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å' %></button>
    <button class="settings-tab" data-tab="backup">üíæ <%= t('settings.tabBackup') || '–ë—ç–∫–∞–ø—ã' %></button>
    <button class="settings-tab" data-tab="maintenance">üîß <%= t('settings.tabMaintenance') || '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' %></button>
</div>

<!-- ==================== TAB: SYSTEM ==================== -->
<div class="tab-content active" id="tab-system">
    <!-- System Info Row -->
    <div class="row" style="margin-bottom: 1.5rem;">
        <div class="col-4">
            <div class="card">
                <div class="card-body" style="padding: 1rem;">
                    <div class="settings-list">
                        <div class="setting-item">
                            <label><%= t('settings.baseUrl') %></label>
                            <code style="font-size: 11px;"><%= config.BASE_URL %></code>
                        </div>
                        <div class="setting-item">
                            <label><%= t('settings.mongodb') %></label>
                            <code style="font-size: 11px;"><%= config.MONGO_URI.replace(/\/\/.*@/, '//***@').substring(0, 30) %>...</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card">
                <div class="card-body" style="padding: 1rem;">
                    <div class="settings-list">
                        <div class="setting-item">
                            <label>Uptime</label>
                            <span><%= Math.floor(process.uptime() / 3600) %>h <%= Math.floor((process.uptime() % 3600) / 60) %>m</span>
                        </div>
                        <div class="setting-item">
                            <label>Memory / Node.js</label>
                            <span><%= Math.round(process.memoryUsage().heapUsed / 1024 / 1024) %> MB / <%= process.version %></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card">
                <div class="card-body" style="padding: 1rem;">
                    <% if (ssl.enabled) { %>
                    <div style="color: var(--success); font-weight: 500;">‚úÖ HTTPS</div>
                    <div style="font-size: 12px; color: var(--text-muted);"><%= ssl.domain %></div>
                    <% } else { %>
                    <div style="color: var(--warning); font-weight: 500;">‚ö†Ô∏è HTTP</div>
                    <div style="font-size: 12px; color: var(--text-muted);">SSL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Settings Form -->
    <form method="POST" action="/panel/settings">
        <!-- Row 1: Load Balancing + Limits -->
        <div class="row" style="margin-bottom: 1rem;">
            <div class="col-6">
                <div class="card">
                    <div class="card-header">
                        <h2><%= t('settings.loadBalancing') %></h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-list">
                            <label class="checkbox-label">
                                <input type="checkbox" name="loadBalancing.enabled" 
                                       <%= settings?.loadBalancing?.enabled ? 'checked' : '' %>>
                                <span><%= t('settings.loadBalancingEnabled') %></span>
                            </label>
                            <small class="hint" style="display: block; margin-top: 0.25rem;">
                                <%= t('settings.loadBalancingHint') %>
                            </small>
                            
                            <label class="checkbox-label" style="margin-top: 0.75rem;">
                                <input type="checkbox" name="loadBalancing.hideOverloaded" 
                                       <%= settings?.loadBalancing?.hideOverloaded ? 'checked' : '' %>>
                                <span><%= t('settings.hideOverloaded') %></span>
                            </label>
                            <small class="hint" style="display: block; margin-top: 0.25rem;">
                                <%= t('settings.hideOverloadedHint') %>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6">
                <div class="card">
                    <div class="card-header">
                        <h2><%= t('settings.deviceLimit') %> & <%= t('settings.rateLimiting') %></h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="deviceGracePeriod"><%= t('settings.gracePeriod') %></label>
                                <input type="number" name="deviceGracePeriod" id="deviceGracePeriod" 
                                       value="<%= settings?.deviceGracePeriod ?? 15 %>" min="1" max="60">
                                <small class="hint"><%= t('settings.gracePeriodHint') %></small>
                            </div>
                            <div class="form-group">
                                <label for="rateLimit.subscriptionPerMinute"><%= t('settings.subscriptionsPerMinute') %></label>
                                <input type="number" name="rateLimit.subscriptionPerMinute" id="rateLimit.subscriptionPerMinute" 
                                       value="<%= settings?.rateLimit?.subscriptionPerMinute || 100 %>" min="10" max="1000">
                                <small class="hint"><%= t('settings.subscriptionsPerMinuteHint') %></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Row 2: Caching + SSH Pool -->
        <div class="row" style="margin-bottom: 1rem;">
            <div class="col-6">
                <div class="card">
                    <div class="card-header">
                        <h2><%= t('settings.caching') %></h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="cache.subscriptionTTL"><%= t('settings.subscriptionsTTL') %></label>
                                <input type="number" name="cache.subscriptionTTL" id="cache.subscriptionTTL" 
                                       value="<%= settings?.cache?.subscriptionTTL || 3600 %>" min="60" max="86400">
                                <small class="hint"><%= t('settings.subscriptionsTTLHint') %></small>
                            </div>
                            <div class="form-group">
                                <label for="cache.userTTL"><%= t('settings.usersTTL') %></label>
                                <input type="number" name="cache.userTTL" id="cache.userTTL" 
                                       value="<%= settings?.cache?.userTTL || 900 %>" min="60" max="3600">
                                <small class="hint"><%= t('settings.usersTTLHint') %></small>
                            </div>
                            <div class="form-group">
                                <label for="cache.onlineSessionsTTL"><%= t('settings.onlineSessionsTTL') %></label>
                                <input type="number" name="cache.onlineSessionsTTL" id="cache.onlineSessionsTTL" 
                                       value="<%= settings?.cache?.onlineSessionsTTL || 10 %>" min="5" max="60">
                                <small class="hint"><%= t('settings.onlineSessionsTTLHint') %></small>
                            </div>
                            <div class="form-group">
                                <label for="cache.activeNodesTTL"><%= t('settings.activeNodesTTL') %></label>
                                <input type="number" name="cache.activeNodesTTL" id="cache.activeNodesTTL" 
                                       value="<%= settings?.cache?.activeNodesTTL || 30 %>" min="10" max="300">
                                <small class="hint"><%= t('settings.activeNodesTTLHint') %></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-6">
                <div class="card">
                    <div class="card-header">
                        <h2><%= t('settings.sshPool') %></h2>
                    </div>
                    <div class="card-body">
                        <label class="checkbox-label" style="margin-bottom: 0.75rem;">
                            <input type="checkbox" name="sshPool.enabled" 
                                   <%= settings?.sshPool?.enabled !== false ? 'checked' : '' %>>
                            <span><%= t('settings.sshPoolEnabled') %></span>
                        </label>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="sshPool.maxIdleTime"><%= t('settings.sshPoolIdleTime') %></label>
                                <input type="number" name="sshPool.maxIdleTime" id="sshPool.maxIdleTime" 
                                       value="<%= settings?.sshPool?.maxIdleTime || 120 %>" min="30" max="600">
                            </div>
                            <div class="form-group">
                                <label for="sshPool.connectTimeout"><%= t('settings.sshPoolTimeout') %></label>
                                <input type="number" name="sshPool.connectTimeout" id="sshPool.connectTimeout" 
                                       value="<%= settings?.sshPool?.connectTimeout || 15 %>" min="5" max="60">
                            </div>
                            <div class="form-group">
                                <label for="sshPool.keepAliveInterval"><%= t('settings.sshPoolKeepalive') %></label>
                                <input type="number" name="sshPool.keepAliveInterval" id="sshPool.keepAliveInterval" 
                                       value="<%= settings?.sshPool?.keepAliveInterval || 30 %>" min="10" max="120">
                            </div>
                            <div class="form-group">
                                <label for="sshPool.maxRetries"><%= t('settings.sshPoolRetries') %></label>
                                <input type="number" name="sshPool.maxRetries" id="sshPool.maxRetries" 
                                       value="<%= settings?.sshPool?.maxRetries || 2 %>" min="0" max="5">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div style="display: flex; justify-content: flex-end; margin-top: 0.5rem;">
            <button type="submit" class="btn btn-primary" style="padding: 0.75rem 2rem; font-size: 15px;">
                <%= t('settings.saveAllSettings') %>
            </button>
        </div>
    </form>
</div>

<!-- ==================== TAB: SECURITY ==================== -->
<div class="tab-content" id="tab-security">
    <div class="row">
        <div class="col-6">
            <div class="card">
                <div class="card-header">
                    <h2><%= t('settings.administrator') %></h2>
                </div>
                <div class="card-body">
                    <div class="settings-list">
                        <div class="setting-item">
                            <label><%= t('settings.administrator') %></label>
                            <span><%= admin?.username || 'N/A' %></span>
                        </div>
                        <div class="setting-item">
                            <label><%= t('settings.lastLogin') %></label>
                            <span><%= admin?.lastLogin ? new Date(admin.lastLogin).toLocaleString(lang === 'en' ? 'en-US' : 'ru-RU') : t('settings.never') %></span>
                        </div>
                        <div class="setting-item">
                            <label><%= t('settings.ipWhitelist') %></label>
                            <span><%= config.PANEL_IP_WHITELIST || t('settings.ipWhitelistDisabled') %></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Node Auth API - –ø–æ–¥ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º -->
            <div class="card" style="margin-top: 1rem;">
                <div class="card-header">
                    <h2><%= t('settings.nodeAuth') || 'Node Auth API' %></h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="/panel/settings">
                        <label class="checkbox-label" style="margin-bottom: 0.75rem;">
                            <input type="checkbox" name="nodeAuth.insecure"
                                   <%= settings?.nodeAuth?.insecure !== false ? 'checked' : '' %>>
                            <span><%= t('settings.nodeAuthInsecure') || 'Allow self-signed certificates' %></span>
                        </label>
                        <p class="hint" style="margin-bottom: 1rem;">
                            <%= t('settings.nodeAuthInsecureHint') || 'Enable if panel uses HTTP or self-signed SSL. Nodes will accept any certificate when connecting to auth API. Disable for production with valid SSL.' %>
                        </p>
                        <button type="submit" class="btn btn-primary"><%= t('common.save') || 'Save' %></button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-6">
            <div class="card">
                <div class="card-header">
                    <h2><%= t('settings.changePassword') %></h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="/panel/settings/password">
                        <div class="form-group">
                            <label><%= t('settings.currentPassword') %></label>
                            <input type="password" name="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label><%= t('settings.newPassword') %></label>
                            <input type="password" name="newPassword" minlength="6" required>
                        </div>
                        <div class="form-group">
                            <label><%= t('settings.confirmPassword') %></label>
                            <input type="password" name="confirmPassword" minlength="6" required>
                        </div>
                        <button type="submit" class="btn btn-primary"><%= t('settings.changePasswordBtn') %></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== TAB: BACKUP ==================== -->
<div class="tab-content" id="tab-backup">
    <div class="row" style="align-items: stretch;">
        <div class="col-6" style="display: flex;">
            <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                <div class="card-header">
                    <h2><%= t('settings.autoBackup') %></h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="/panel/settings" id="backupSettingsForm">
                        <input type="hidden" name="_backupSettings" value="1">
                        
                        <div class="settings-list" style="margin-bottom: 1rem;">
                            <label class="checkbox-label">
                                <input type="checkbox" name="backup.enabled" id="backupEnabled"
                                       <%= settings?.backup?.enabled ? 'checked' : '' %>>
                                <span><%= t('settings.autoBackup') %></span>
                            </label>
                            <small class="hint" style="display: block; margin-top: 0.25rem;">
                                <%= t('settings.autoBackupHint') %>
                            </small>
                        </div>
                        
                        <div id="backupSettings" style="<%= settings?.backup?.enabled ? '' : 'display: none;' %>">
                            <div class="settings-grid" style="margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label for="backup.intervalHours"><%= t('settings.backupInterval') %></label>
                                    <input type="number" name="backup.intervalHours" id="backup.intervalHours" 
                                           value="<%= settings?.backup?.intervalHours || 24 %>" min="1" max="168">
                                    <small class="hint"><%= t('settings.backupIntervalHint') %></small>
                                </div>
                                <div class="form-group">
                                    <label for="backup.keepLast"><%= t('settings.keepLast') %></label>
                                    <input type="number" name="backup.keepLast" id="backup.keepLast" 
                                           value="<%= settings?.backup?.keepLast || 7 %>" min="1" max="30">
                                    <small class="hint"><%= t('settings.keepLastHint') %></small>
                                </div>
                            </div>
                            
                            <div class="setting-item" style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                                <label><%= t('settings.lastBackup') %></label>
                                <span id="lastBackupTime">
                                    <%= settings?.backup?.lastBackup 
                                        ? new Date(settings.backup.lastBackup).toLocaleString(lang === 'en' ? 'en-US' : 'ru-RU') 
                                        : t('settings.never') %>
                                </span>
                            </div>
                        </div>
                        
                        <hr style="margin: 1rem 0; border-color: var(--border);">
                        
                        <h4 style="margin-bottom: 0.75rem;"><%= t('settings.s3Settings') %></h4>
                        
                        <div class="settings-list" style="margin-bottom: 1rem;">
                            <label class="checkbox-label">
                                <input type="checkbox" name="backup.s3.enabled" id="s3Enabled"
                                       <%= settings?.backup?.s3?.enabled ? 'checked' : '' %>>
                                <span><%= t('settings.s3Enabled') %></span>
                            </label>
                            <small class="hint" style="display: block; margin-top: 0.25rem;">
                                <%= t('settings.s3EnabledHint') %>
                            </small>
                        </div>
                        
                        <div id="s3Settings" style="<%= settings?.backup?.s3?.enabled ? '' : 'display: none;' %>">
                            <div class="settings-grid" style="margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label for="backup.s3.endpoint"><%= t('settings.s3Endpoint') %></label>
                                    <input type="text" name="backup.s3.endpoint" id="backup.s3.endpoint" 
                                           value="<%= settings?.backup?.s3?.endpoint || '' %>" 
                                           placeholder="https://s3.example.com">
                                </div>
                                <div class="form-group">
                                    <label for="backup.s3.region"><%= t('settings.s3Region') %></label>
                                    <input type="text" name="backup.s3.region" id="backup.s3.region" 
                                           value="<%= settings?.backup?.s3?.region || 'us-east-1' %>">
                                </div>
                                <div class="form-group">
                                    <label for="backup.s3.bucket"><%= t('settings.s3Bucket') %> *</label>
                                    <input type="text" name="backup.s3.bucket" id="backup.s3.bucket" 
                                           value="<%= settings?.backup?.s3?.bucket || '' %>">
                                </div>
                                <div class="form-group">
                                    <label for="backup.s3.prefix"><%= t('settings.s3Prefix') %></label>
                                    <input type="text" name="backup.s3.prefix" id="backup.s3.prefix" 
                                           value="<%= settings?.backup?.s3?.prefix || 'backups' %>">
                                </div>
                                <div class="form-group">
                                    <label for="backup.s3.accessKeyId"><%= t('settings.s3AccessKey') %> *</label>
                                    <input type="text" name="backup.s3.accessKeyId" id="backup.s3.accessKeyId" 
                                           value="<%= settings?.backup?.s3?.accessKeyId || '' %>">
                                </div>
                                <div class="form-group">
                                    <label for="backup.s3.secretAccessKey"><%= t('settings.s3SecretKey') %> *</label>
                                    <input type="password" name="backup.s3.secretAccessKey" id="backup.s3.secretAccessKey" 
                                           value="<%= settings?.backup?.s3?.secretAccessKey || '' %>">
                                </div>
                                <div class="form-group">
                                    <label for="backup.s3.keepLast"><%= t('settings.s3KeepLast') %></label>
                                    <input type="number" name="backup.s3.keepLast" id="backup.s3.keepLast" 
                                           value="<%= settings?.backup?.s3?.keepLast || 30 %>" min="1" max="365">
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-secondary btn-sm" onclick="testS3Connection()" id="testS3Btn">
                                <%= t('settings.testS3') %>
                            </button>
                            <span id="s3TestResult" style="margin-left: 0.5rem;"></span>
                        </div>
                        
                        <hr style="margin: 1rem 0; border-color: var(--border);">
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-primary">üíæ <%= t('common.save') %></button>
                            <button type="button" class="btn btn-success" onclick="createBackupNow()" id="createBackupBtn">
                                <%= t('settings.createBackupNow') %>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-6" style="display: flex;">
            <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>üìã <%= t('settings.backupsList') || '–î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã' %></h2>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="loadBackupsList()" id="refreshBackupsBtn">
                        üîÑ <%= t('common.refresh') %>
                    </button>
                </div>
                <div class="card-body" style="flex: 1; overflow-y: auto;">
                    <div id="backupsList">
                        <p style="color: var(--text-muted); font-size: 13px;"><%= t('settings.clickRefresh') || '–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞' %></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== TAB: MAINTENANCE ==================== -->
<div class="tab-content" id="tab-maintenance">
    <div class="row">
        <div class="col-6">
            <div class="card">
                <div class="card-header">
                    <h2><%= t('settings.cacheManagement') %></h2>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 1rem;">
                        <%= t('settings.flushCacheDesc') %>
                    </p>
                    <button class="btn btn-warning" onclick="flushCache()">
                        <%= t('settings.flushCacheBtn') %>
                    </button>
                </div>
            </div>
            
            <div class="card mt-2">
                <div class="card-header">
                    <h2><%= t('settings.resetStats') || '–°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏' %></h2>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 1rem;">
                        <%= t('settings.resetStatsDesc') || '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.' %>
                    </p>
                    <button class="btn btn-warning" onclick="resetStats()">
                        <%= t('settings.resetStatsBtn') || '–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É' %>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-6">
            <div class="card" style="border-color: var(--danger);">
                <div class="card-header" style="background: rgba(239, 68, 68, 0.1);">
                    <h2 style="color: var(--danger);"><%= t('settings.dangerZone') %></h2>
                </div>
                <div class="card-body">
                    <h4 style="margin-bottom: 0.5rem;"><%= t('settings.resetTrafficCounter') %></h4>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 1rem;">
                        <%= t('settings.resetTrafficDesc') %>
                    </p>
                    <button class="btn btn-danger" onclick="resetTraffic()">
                        <%= t('settings.resetAllTraffic') %>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
const i18n = {
    resetConfirm: <%- JSON.stringify(t("settings.resetConfirm")) %>,
    resetConfirmFinal: <%- JSON.stringify(t("settings.resetConfirmFinal")) %>,
    resetting: <%- JSON.stringify(t("settings.resetting")) %>,
    resetAllTraffic: <%- JSON.stringify(t("settings.resetAllTraffic")) %>,
    trafficReset: <%- JSON.stringify(t("settings.trafficReset")) %>,
    error: <%- JSON.stringify(t("common.error")) %>,
    flushCacheConfirm: <%- JSON.stringify(t("settings.flushCacheConfirm")) %>,
    flushing: <%- JSON.stringify(t("settings.flushing")) %>,
    flushCacheBtn: <%- JSON.stringify(t("settings.flushCacheBtn")) %>,
    cacheFlushed: <%- JSON.stringify(t("settings.cacheFlushed")) %>,
    resetStatsConfirm: <%- JSON.stringify(t("settings.resetStatsConfirm") || "–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏?") %>,
    resetStatsBtn: <%- JSON.stringify(t("settings.resetStatsBtn") || "–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É") %>,
    statsReset: <%- JSON.stringify(t("settings.statsReset") || "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–∏—â–µ–Ω–∞ ({count} –∑–∞–ø–∏—Å–µ–π)") %>,
    testS3: <%- JSON.stringify(t("settings.testS3")) %>,
    testingS3: <%- JSON.stringify(t("settings.testingS3")) %>,
    s3TestSuccess: <%- JSON.stringify(t("settings.s3TestSuccess")) %>,
    s3TestError: <%- JSON.stringify(t("settings.s3TestError")) %>,
    createBackupNow: <%- JSON.stringify(t("settings.createBackupNow")) %>,
    creatingBackup: <%- JSON.stringify(t("settings.creatingBackup")) %>,
    backupCreated: <%- JSON.stringify(t("settings.backupCreated")) %>,
    backupError: <%- JSON.stringify(t("settings.backupError")) %>,
    restoreConfirm: <%- JSON.stringify(t("settings.restoreConfirm") || "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —ç—Ç–æ–≥–æ –±—ç–∫–∞–ø–∞? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã!") %>,
    restoring: <%- JSON.stringify(t("settings.restoring") || "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...") %>,
    restored: <%- JSON.stringify(t("settings.restored") || "‚úì –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...") %>,
    restoreError: <%- JSON.stringify(t("settings.restoreError") || "–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è") %>,
    noBackups: <%- JSON.stringify(t("settings.noBackups") || "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤") %>,
    localBackups: <%- JSON.stringify(t("settings.localBackups") || "–õ–æ–∫–∞–ª—å–Ω—ã–µ") %>,
    s3Backups: <%- JSON.stringify(t("settings.s3Backups") || "S3") %>
};

// ==================== TABS ====================
document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        // Remove active from all
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active to clicked
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        
        // Save to localStorage
        localStorage.setItem('settings-tab', tab.dataset.tab);
    });
});

// Restore tab from localStorage
const savedTab = localStorage.getItem('settings-tab');
if (savedTab) {
    const tab = document.querySelector(`.settings-tab[data-tab="${savedTab}"]`);
    if (tab) tab.click();
}

// ==================== BACKUP ====================
document.getElementById('backupEnabled')?.addEventListener('change', function() {
    document.getElementById('backupSettings').style.display = this.checked ? '' : 'none';
});

document.getElementById('s3Enabled')?.addEventListener('change', function() {
    document.getElementById('s3Settings').style.display = this.checked ? '' : 'none';
});

async function testS3Connection() {
    const btn = document.getElementById('testS3Btn');
    const result = document.getElementById('s3TestResult');
    
    btn.disabled = true;
    btn.textContent = i18n.testingS3;
    result.textContent = '';
    
    try {
        const res = await fetch('/panel/settings/test-s3', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                endpoint: document.getElementById('backup.s3.endpoint').value,
                region: document.getElementById('backup.s3.region').value,
                bucket: document.getElementById('backup.s3.bucket').value,
                accessKeyId: document.getElementById('backup.s3.accessKeyId').value,
                secretAccessKey: document.getElementById('backup.s3.secretAccessKey').value,
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            result.textContent = i18n.s3TestSuccess;
            result.style.color = 'var(--success)';
        } else {
            result.textContent = i18n.s3TestError.replace('{error}', data.error);
            result.style.color = 'var(--danger)';
        }
    } catch (e) {
        result.textContent = i18n.s3TestError.replace('{error}', e.message);
        result.style.color = 'var(--danger)';
    }
    
    btn.disabled = false;
    btn.textContent = i18n.testS3;
}

async function createBackupNow() {
    const btn = document.getElementById('createBackupBtn');
    btn.disabled = true;
    btn.textContent = i18n.creatingBackup;
    
    try {
        const res = await fetch('/panel/settings/create-backup', {
            method: 'POST',
            credentials: 'include'
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.backupCreated.replace('{filename}', data.filename).replace('{size}', data.size), 'success');
            document.getElementById('lastBackupTime').textContent = new Date().toLocaleString();
            loadBackupsList();
        } else {
            showToast(i18n.backupError + ': ' + (data.error || 'unknown'), 'error');
        }
    } catch (e) {
        showToast(i18n.backupError + ': ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.textContent = i18n.createBackupNow;
}

async function loadBackupsList() {
    const container = document.getElementById('backupsList');
    const btn = document.getElementById('refreshBackupsBtn');
    
    btn.disabled = true;
    container.innerHTML = '<p style="color: var(--text-muted);">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    
    try {
        const [localRes, s3Res] = await Promise.all([
            fetch('/panel/settings/backups', { credentials: 'include' }),
            fetch('/panel/settings/backups-s3', { credentials: 'include' })
        ]);
        
        const localData = await localRes.json();
        const s3Data = await s3Res.json();
        
        const localBackups = (localData.backups || []).map(b => ({ ...b, source: 'local' }));
        const s3Backups = s3Data.backups || [];
        
        if (localBackups.length === 0 && s3Backups.length === 0) {
            container.innerHTML = `<p style="color: var(--text-muted);">${i18n.noBackups}</p>`;
            btn.disabled = false;
            return;
        }
        
        let html = '';
        
        if (localBackups.length > 0) {
            html += `<div style="margin-bottom: 0.75rem; font-weight: 600;">üíæ ${i18n.localBackups} (${localBackups.length})</div>`;
            html += '<div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem;">';
            for (const b of localBackups) {
                const date = new Date(b.created).toLocaleString();
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: var(--bg-tertiary); border-radius: 6px;">
                        <div>
                            <div style="font-size: 13px; font-weight: 500;">${b.name}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${date} ‚Ä¢ ${b.sizeMB} MB</div>
                        </div>
                        <button class="btn btn-warning btn-sm" onclick="restoreBackup('local', '${b.name}')" style="padding: 4px 10px; font-size: 11px;">
                            Restore
                        </button>
                    </div>
                `;
            }
            html += '</div>';
        }
        
        if (s3Backups.length > 0) {
            html += `<div style="margin-bottom: 0.75rem; font-weight: 600;">‚òÅÔ∏è ${i18n.s3Backups} (${s3Backups.length})</div>`;
            html += '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            for (const b of s3Backups) {
                const date = new Date(b.created).toLocaleString();
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: var(--bg-tertiary); border-radius: 6px;">
                        <div>
                            <div style="font-size: 13px; font-weight: 500;">${b.name}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${date} ‚Ä¢ ${b.sizeMB} MB</div>
                        </div>
                        <button class="btn btn-warning btn-sm" onclick="restoreBackup('s3', '${b.key}')" style="padding: 4px 10px; font-size: 11px;">
                            Restore
                        </button>
                    </div>
                `;
            }
            html += '</div>';
        }
        
        container.innerHTML = html;
        
    } catch (e) {
        container.innerHTML = `<p style="color: var(--danger);">Error: ${e.message}</p>`;
    }
    
    btn.disabled = false;
}

async function restoreBackup(source, identifier) {
    if (!confirm(i18n.restoreConfirm)) return;
    
    showToast(i18n.restoring, 'info');
    
    try {
        const res = await fetch('/panel/settings/restore-backup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ source, identifier })
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.restored, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast(i18n.restoreError + ': ' + (data.error || 'unknown'), 'error');
        }
    } catch (e) {
        showToast(i18n.restoreError + ': ' + e.message, 'error');
    }
}

// ==================== MAINTENANCE ====================
async function resetStats() {
    if (!confirm(i18n.resetStatsConfirm)) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = i18n.resetting;
    
    try {
        const res = await fetch('/panel/settings/reset-stats', { method: 'POST', credentials: 'include' });
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.statsReset.replace('{count}', data.count), 'success');
        } else {
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
        }
    } catch (e) {
        showToast(i18n.error, 'error');
    }
    
    btn.disabled = false;
    btn.textContent = i18n.resetStatsBtn;
}

async function flushCache() {
    if (!confirm(i18n.flushCacheConfirm)) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = i18n.flushing;
    
    try {
        const res = await fetch('/panel/settings/flush-cache', { method: 'POST', credentials: 'include' });
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.cacheFlushed, 'success');
        } else {
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
        }
    } catch (e) {
        showToast(i18n.error, 'error');
    }
    
    btn.disabled = false;
    btn.textContent = i18n.flushCacheBtn;
}

async function resetTraffic() {
    if (!confirm(i18n.resetConfirm)) return;
    if (!confirm(i18n.resetConfirmFinal)) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = i18n.resetting;
    
    try {
        const res = await fetch('/panel/settings/reset-traffic', { method: 'POST', credentials: 'include' });
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.trafficReset.replace('{count}', data.count), 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
            btn.disabled = false;
            btn.textContent = i18n.resetAllTraffic;
        }
    } catch (e) {
        showToast(i18n.error, 'error');
        btn.disabled = false;
        btn.textContent = i18n.resetAllTraffic;
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 3000);
}
</script>
